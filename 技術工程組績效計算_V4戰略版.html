<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°¸å®šç”Ÿç‰©ç§‘æŠ€ - æŠ€è¡“éƒ¨ KPI å„€è¡¨æ¿ (V4.12 å°ˆæ¥­ BI æˆ°æƒ…å®¤ç‰ˆ)</title>
    <!-- å¼•å…¥ Chart.js ç”¨æ–¼ç¹ªè£½åœ–è¡¨ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- æ ¸å¿ƒæ¨£å¼ --- */
        :root { --primary: #0284c7; --bg: #f8fafc; --text: #334155; --border: #e2e8f0; --accent: #4f46e5; }
        body { font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; line-height: 1.5; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        .section { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid var(--border); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; }
        .title h1 { margin: 0; font-size: 1.5rem; color: #0f172a; }
        .title p { margin: 5px 0 0; color: #64748b; font-size: 0.9rem; }

        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; align-items: end; }
        .control-group label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; color: #475569; }
        .control-group input, .control-group select { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
        
        .file-box { border: 2px dashed #94a3b8; background: #f1f5f9; border-radius: 8px; text-align: center; padding: 15px; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; justify-content: center; }
        .file-box:hover { border-color: var(--primary); background: #e0f2fe; }

        .config-panel { background: #fff7ed; border: 1px solid #fdba74; padding: 15px; border-radius: 8px; font-size: 0.9rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; }
        .config-item { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.5); padding: 5px; border-radius: 4px;}
        .config-item span { font-weight: 500; color: #7c2d12; }
        .config-item input { width: 60px; padding: 2px 5px; text-align: center; border: 1px solid #fdba74; border-radius: 4px; font-weight: bold; color: #c2410c; }

        /* KPI Cards */
        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .kpi-card { background: white; padding: 15px; border-radius: 10px; border-left: 5px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; border-left-width: 5px; display: flex; flex-direction: column;}
        .kpi-val { font-size: 1.6rem; font-weight: 800; color: #1e293b; margin: 5px 0; }
        .kpi-label { font-size: 0.85rem; color: #64748b; font-weight: 500; }
        .kpi-sub { font-size: 0.75rem; color: #94a3b8; margin-top: auto; }
        
        /* Strategic Cards */
        .strategic-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px dashed #cbd5e1;}

        /* Tabs (V4.12 New) */
        .tabs-container { border-bottom: 2px solid var(--border); margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 20px; border: none; background: transparent; font-size: 1rem; font-weight: bold; color: #64748b; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .tab-btn:hover { color: var(--primary); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: #f8fafc; text-align: left; padding: 10px; font-size: 0.8rem; color: #475569; border-bottom: 2px solid var(--border); white-space: nowrap; }
        td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 0.9rem; vertical-align: middle; }
        tr:hover { background: #f1f5f9; }
        
        .score-good { color: #15803d; background: #dcfce7; padding: 2px 6px; border-radius: 4px; font-weight: bold;}
        .score-bad { color: #b91c1c; background: #fee2e2; padding: 2px 6px; border-radius: 4px; font-weight: bold;}
        .score-mid { color: #b45309; background: #ffedd5; padding: 2px 6px; border-radius: 4px; font-weight: bold;}
        
        .tag-recall { background: #fee2e2; color: #991b1b; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; border: 1px solid #fecaca; font-weight: bold; }
        .eng-link { color: var(--primary); cursor: pointer; text-decoration: underline; font-weight: bold; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 20px; border-radius: 12px; width: 90%; max-width: 1000px; max-height: 85vh; overflow-y: auto; position: relative; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }

        /* Charts */
        .chart-controls { display: flex; gap: 10px; margin-bottom: 15px; justify-content: space-between; align-items: center; flex-wrap: wrap;}
        .chart-btn-group { display: flex; gap: 10px; }
        .chart-btn { padding: 6px 12px; border: 1px solid #cbd5e1; background: white; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: bold; color: #475569; }
        .chart-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .chart-grid-top { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-grid-bottom { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; }
        .chart-container { position: relative; height: 320px; width: 100%; }
        
        #filterNotice { display: none; background: #ecfdf5; color: #065f46; padding: 5px 15px; border-radius: 20px; border: 1px solid #10b981; font-size: 0.9rem; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        #filterNotice:hover { background: #d1fae5; }

        /* Custom Multi-Select */
        .multi-select-box { padding:6px; border-radius:6px; border:1px solid #cbd5e1; font-size:0.9rem; min-width:150px; background:white; cursor:pointer; display:flex; justify-content:space-between; align-items:center; user-select:none; }
        .multi-select-menu { display:none; position:absolute; top:100%; left:0; min-width:100%; background:white; border:1px solid #cbd5e1; border-radius:6px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index:50; max-height:250px; overflow-y:auto; padding:5px; margin-top:2px; white-space:nowrap; }
        .multi-select-menu.active { display:block; }
        .multi-select-menu label { display:flex; align-items:center; gap:6px; padding:6px 8px; cursor:pointer; font-size:0.85rem; border-radius:4px; margin:0; }
        .multi-select-menu label:hover { background:#f1f5f9; }

        /* Analysis Box */
        .analysis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .analysis-box { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.02);}
        .analysis-title { font-size: 1.1rem; font-weight: bold; color: #1e293b; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 15px; }
        .analysis-content { font-size: 0.95rem; color: #475569; line-height: 1.6; }
        .analysis-content ul { padding-left: 20px; margin: 0; }
        .analysis-content li { margin-bottom: 10px; }
        .highlight-red { color: #dc2626; font-weight: bold; background: #fee2e2; padding: 2px 4px; border-radius: 3px; }
        .highlight-green { color: #15803d; font-weight: bold; }
        .highlight-blue { color: #0369a1; font-weight: bold; }

        /* Top 5 Customers Styles */
        .top-customer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px; }
        .customer-card { background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 8px; padding: 15px; transition: transform 0.2s; display:flex; flex-direction:column;}
        .customer-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-color: var(--primary); }
        .cust-rank { font-size: 0.8rem; color: #64748b; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .cust-name { font-size: 1.1rem; font-weight: bold; color: #0f172a; margin-bottom: 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cust-stat { font-size: 0.9rem; color: #475569; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .cust-stat span { font-weight: 500; }
        .cust-suggestion { margin-top: auto; padding: 8px; background: #fff7ed; border-radius: 4px; font-size: 0.85rem; color: #9a3412; border: 1px dashed #fdba74; }
        .cust-parts { margin: 8px 0; font-size: 0.85rem; color: #64748b; background: white; padding: 5px; border-radius: 4px; border: 1px solid #f1f5f9; }
        .cust-parts-title { font-weight: bold; margin-bottom: 3px; color: #334155; font-size: 0.8rem; }

        @media print {
            .no-print { display: none !important; }
            body { padding: 0; background: white; }
            .section { box-shadow: none; border: none; padding: 0; margin-bottom: 20px; }
            .container { max-width: 100%; }
            .top-customer-grid { display: block; }
            .customer-card { margin-bottom: 10px; break-inside: avoid; }
            .tabs-container { display: none; }
            .tab-content { display: block !important; }
        }
    </style>
</head>
<body>
    <script>
        // =========================================================================
        // ğŸ› ï¸ å…§å»ºé›¶ä»¶é€²è²¨æˆæœ¬è³‡æ–™åº« (CSV æ–‡å­—æ ¼å¼)
        // =========================================================================
        const rawCostCSV = `
Part Number,é€²è²¨åƒ¹
1080757,0
1080758_B,1665
1143320,0
1080759,0
1064736,0
1064747,0
1099560,0
1109061,29
1064752,0
1099563,0
1074113,0
1115532,3270
1115533,3270
1115534,3270
1115536,0
1115537,0
1068963,3270
1068961,0
1083253,0
1099578,0
1091398,1200
1091399,0
1064748,0
1103210,0
1099564,0
1099591,0
1099592,0
1080760,29
1064766,
1103402,0
1100750,0
1100578,0
1099579,0
1099567,0
1099580,0
1099566,0
1099565,0
1040889,0
1099581,0
1064787,0
332353,0
312710,0
1099562,0
1099561,0
1064803,0
1064804,0
1099588,0
1099589,303
1099585,45
1064807,0
1099586,0
1099582,0
1099587,0
1064804,0
1099578,0
1064798,0
1099590,0
1035443,0
1029330,0
1035442,0
1029331,0
1061644A,0
1063857,0
1063859,0
1114784,0
1032907,0
SYS1HT15,0
INX500T15,23000
1115485,17.98
1115542,17.98
1115486,314.65
1115538,973.4
1133830,
1121520,6207.75
1121522,6207.75
1121523,6207.75
1121525,6207.75
1121526,6207.75
1121527,5.58
1115484,10.85
1115481,194.68
1121548,230.33
1151316B,230.33
1121550,1868.68
1121552,40.3
1121549,1868.68
1121551,40.3
1121553,27.28
1121554,613.8
1121555,5.58
1115543,66.03
1121559,14.88
1130435,412.3
1151266,0
1151317,0
1151338,0
1152522,114.7
1152526,114.7
1152268,114.7
1152530,114.7
1152261,114.7
1118499,2861.61
1144267,2861.61
1120136,3100
1127194,0
1127195,0
1127196,0
1127197,0
1127238,0
1038928,597.68
PR15,1025.48
PR12,1208.69
HT15,2098.39
1120668,932.48
1120613,248
1120873,1614.48
1120617,372
1121569,20.15
1120614,96.1
1121570,48.05
1120616,45.88
1122522,15.5
1120669,10.85
1120615,27.9
1126545,25.73
1126543,12.4
EUXH,1457
1032907,644.8
1122520,1430.65
1121568,119.35
1128163,0
1122446,93
1122447,62
1122518,111.6
1122519,279
1121694,7244.39
ZZZ-100,0
ZZZ-101,0
ZZZ-102,0
ZZZ-103,0
ZZZ-104,0
ZZZ-099,0
ZZZZ-0023,0
ZZZ-021,0
ZZZ-010,0
ZZZZ-010,0
ZZZZ-0031,0
100600C,0
100605C,0
100700W,0
100705W,0
1040889,0
1133830,85.25
1120293,1791.8
1122135,0
1121162,0
1126942,17949
1126944,0
1139752,0
1126240,1736
INXH,620
1037268,155
1008198,155
1127131,465
1063859,2418
1145085,2418
1133905,2701.03
1133915,6207.75
1133916,6207.75
1133907,511.5
1133904,227.23
1133914,2786.9
1133903,41.85
1133902,27.9
1133912,26.35
1133900,93
1133901,42.78
1115484,10.85
1133910,63.55
1133913,13.33
1133906,3271.43
1133899,165.23
1133911,214.83
1133866,279
1135283,73.78
1133743,216.38
1133744,595.2
1133908,93
1133909,97.03
1133741,93.93
1133742,0
1132551,613.8
1132552,613.8
1026062,0
1140261,1519.31
1140262,0
1140264,0
1140267,0
1140266,0
1140278,0
,0
,0
,0
,0
,0
,0
,0
,0
,0
1152681,
INGH,4245.76
1133281,2496.12
1133276,713
1133275,0
PR12,759.81
1136051,12623.51
1136052,2016.86
ZZZ-100,0
ZZZ-101,0
ZZZ-102,0
ZZZ-103,0
ZZZ-104,0
1115485,17.98
1115542,17.98
1115486,314.65
1130519,5053
1130520,5053.93
1130437,636.43
1130523,5497.85
1130734,5497.85
1130737,5497.85
1130524,5497.85
1130758,5497.85
1130759,5497.85
1130760,5497.85
1121527,5.58
1115484,10.85
1115481,194.68
1121548,230.33
1130521,3357.3
1121551,40.3
1121553,27.28
1121554,613.8
1121555,5.58
1115543,66.03
1121559,14.88
1130435,412.3
1132247,114.7
1118499,2861.61
1120136,3100
1038928,613.8
1128518,0
PR15,1025.48
HT15,2098.39
1120668,932.48
1120613,248
1120873,1614.48
1120617,372
1121569,20.15
1120614,96.1
1121570,48.05
1120616,45.88
1122522,15.5
1120669,10.85
1120615,27.9
1126545,25.73
1126543,12.4
1122520,1430.65
1121568,119.35
1128163,0
1122446,93
1122447,62
1122518,111.6
1122519,476.78
1121694,19076.78
1115485,17.98
1115542,17.98
1115486,314.65
1130518,0
1130437,636.43
1130522,0
1121527,5.58
1115484,10.85
1115481,194.68
1121548,230.33
1130521,3357.3
1121551,40.3
1121553,27.28
1121554,613.8
1121555,5.58
1115543,66.03
1121559,14.88
1130435,412.3
1132247,114.7
1118499,2861.61
1120136,3100
1038928,613.8
1128518,0
PR15,1025.48
HT15,2098.39
1120668,932.48
1120613,248
1120873,1614.48
1120617,372
1121569,20.15
1120614,96.1
1121570,48.05
1120616,45.88
1122522,15.5
1120669,10.85
1120615,27.9
1126545,25.73
1126543,12.4
1122520,1430.65
1121568,119.35
1128163,0
1122446,244.9
1122447,95.48
1122518,166.78
1122519,476.78
1121694,19076.78
1045299,450
1045153,15030
1045153B,15030
1045295,3540
1076003,540
1045180,720
1045171,150
1045307,180
1045309,300
1045204,930
1045302,600
1045303,510
1045589,30
1045300,1260
1043570,8584
1045166,660
1045167,150
1045181,90
1045178,1140
1067047,131
1045150,1890
1070249,1257
1045168,360
1105663,4410
1070252,2469
1105664,2469
1105665,2687
1084499,2399
1084502,2498
1084504,2423
1084497,8
1080250,360
1101071,139
1045200,10050
1045306,900
1045590,30
1045175,450
1045587,681
1045296,210
1084485,10230
1084485B,10230
1055806,6587
1045183,390
1105660,38
1105615,6271
1124207,0
1054951,13380
1054951B,13380
1054773,476
1054870,944
1054872,782
1054772,206
1054774,28373
1054774B,28373
1054871,253
1054875,202
1070135,5
1054868,1079
1054775,1223
1054876,326
1054869,269
1054874,178
1054873,
1045588,30
1045170,2430
1045298,1140
1045163,810
1045197,990
1045198,900
1106251,19760
1106251B,19760
1045196,390
1105659,420
1035443,90
1029330,90
1045174,330
1070259,9
1045304,9
1045201,12600
1045151,9900
1058376,465
1045149,1290
1045403,30
1029360,37
1051801,2250
1045152B,17370
1070248,29099
1070248B,29099
1045310,780
1055430,4390
1045311,1110
1064699,1110
1045308,30
1045176,660
1045177,210
1045204,930
1045203,720
1045164,60
1105617,270
1045202,360
1045169,270
1060747,272
1045586,540
1045154,570
1045165,180
1045173,90
1045312,105
1075637,105
332113,599
ZZZ-100,0
1117283,0
1117283B,0
1040390,0
1040370,0
1040372,0
1044750,0
1045172,0
1045301,0
1053716,0
1054670,0
1070250,0
1070251,0
1071789,0
1080901,0
1101464,0
1112813,0
1112814,0
1113030,0
1115041,0
1120671,0
1121867,0
1121888,0
1122270,0
1122838,0
1124469,0
1124470,0
1136584,0
1045151B,9900
1045200B,10050
1045201B,12600
622038,0
1074629,0
1074627,0
HC001,
70530,25
HC002,
HC004,36
H-G-314001,
HC-M-OA,126
HC011,
HC009,
HC008,
HC-OX-2,
HC-NC08460,
HC007,15
HC-CL12,60
1065775,
332113,1300
HC010,11
HC-CS04,20
AHSG-H-F15,
HC012,
R1038831,600
P060002,500
HC-M07521,160
GH-RST-S014,
HC-OM81620,48
HC014,40
P0600003,615
1024487,9161
1141656,0
1141655,0
1093600,2082
1093599,1855
1093604,0
1093603,0
1093605,0
1093606,0
1141653,0
1093608,3420
1024489,703
1024476,322
1024333,491
1024331,1677
1024482,465
1024497,10711
1025463,214
1024473,226
1024466,1522
1093602,1177
1093601,942
1024437,203
1024496,20986
1024481,14062
1024478,3102
1024477L,4753
1093607,6705
1024442,1784
1052624,55
1033550,16321
1093609,16871
1024472,0
1024467,0
1093611,0
1093612,0
1093613,0
1093614,0
1093615,0
1093616,0
1093617,0
1093648,0
1093650,3323
1116182,0
1116184,0
1122392,1404
1124503,0
1124504,0
1124505,0
1130723,0
1141828,0
1079310,1120
1091148,10882
1091149,10764
1091147,11628
1091168,561
1091169,545
1091150,577
1091173,654
1091175,642
1091171,642
1091721,13386
1091720,16105
1091724,121
1091723,129
1091177,145
1091199,83
1091687,6964
1091719,461
1091718,446
1091725,0
1054921,27253
1054922,2845
1053279,233
1054948,106
1054949,9
1055426,673
1055427,619
1055428,55
1054924,1321
1054925,208
1055429,47
1054947,949
1054950,10
1053280,267
1117444,234.36
1117454,197.78
1117455,3386.13
1124158,261.95
1114520,2250.6
1134159,2024.3
1134160,562.65
1134161,1488
1117406,159.03
1134162,159.03
1134163,0
1134164,616.28
1117453,0
1134165,0
1117450,6021.75
1134166,6021.75
1117451,723.85
1134167,723.85
1134168,14394.23
1134169,3100
1117452,188.48
1134170,188.48
1139554,2232.93
1139555,17860.65
1139556,13757.8
1113340,0
1119823,12400
1139418,3188.35
1078754,4992
1078755,6048
1078756,5616
1078757,4320
1076592,14256
P1274,6240
P1336,6720
P1337,6240
P1344,4800
P1304R,9440
P1388,7136
P1379,5350.4
1078925,16231.68
1078926,16231.68
1076333,34400
1076334,34400
1075969,18035.2
1073622,6768
1075970,6768
1075973,7056
P1736R,20640
P1133,1728
P1170,1497.6
1113310,9099.2
1113311,9099.2
1099515,25440
1094110,7200
1094111,7200
P1586,8800
P1587,8800
1075383,12000
1081984,8400
1081515,8400
1081517,8400
1081518,8400
1081519,8400
1081985,8400
1081516,8400
1082474,8400
1122672,9457.92
1062049,9600
1062050,9600
1062051,9600
1019531,4800
1019532,8960
1070518,0
1070520,0
H5871,9600
H5875,13440
H5874,9600
H5873,11520
H5872,12160
1019530,10240
1019531,4480
1019532,8960
1019529,5440
936,8529.28
953,5531.2
954A,1098.24
1116888,2528
1119823,12800
1122694,645.44
1078758,8384
1078752,4032
1069622,6624
P1694,8960
1078753,4032
P1716,4480
1048415,63968
1040810,31968
1041200,2374.4
1040805,928
1040806,1312
1040807,992
P1259,4608
P1301,1152
P1295,5141
P1300,1152
P1267,11424
P1303,2240
P1263,8554
P1302,1728
P1328-60,5760
P1390,774
P1365,0
1075232,0
1075233,818
1016360,816
T716,270
1016361,144
8179,449
8051,372
PG-TEN30,211
8052,547
PG-TEN20,634
1097360,7122
1117858,35680
1074689,2394
1075294,3280
1075397,3827
1075398,4401
1075399,4401
1075400,4020
1075401,4585
1075402,5120
1050795,3456
1019280,2763
362435,0
1104765,242
VCF-048,396
1111076,5658
1016309,0
1024582,0
1043937,0
1053194,0
1055371,0
1082652,0
1082653,0
1071285,0
P1343,6480
1078921,
19777,29750
19776,19125
19779,19125
19696,14450
19711,14450
19703,4800
19704,4800
19698,1280
19725,1200
19726,1200
19761,880
19730,800
19731,800
19763,800
19724,640
19734,640
19735,640
19736,640
19762,640
19795,640
19697,640
19717,640
19745,640
19706,600
19728,600
19766,600
19699,600
19700,600
19719,600
19720,600
19721,600
19722,600
19769,600
19796,600
19799,600
19760,560
19939,560
19702,560
19707,560
19729,560
19733,560
19768,560
19701,400
19770,400
19739,320
19740,320
19741,320
19743,320
37310,350
37347,1500
37300,2000
29028,9500
ZZZ-100,1500
ZZZ-101,500
ZZZ-102,500
ZZZ-103,1500
ZZZ-104,800
ZZZZ-0023,0
ZZZ-021,0
ZZZ-010,0
ZZZZ-0031,0
36821,2000
36850,60
36851,120
36852,600
36853,1800
36855,80
36856,130
36857,1000
36858,2000
36920,850
36931,1100
36944,21000
36950,2000
36995,1700
37296,1650
37297,3800
37299,1500
37301,2700
37302,4200
37303,800
37304,1000
37305,1000
37332,6200
37334,720
37335,800
37343,800
37344,2000
37357,1850
37457,28000
37458,28000
38140,20000
38808,8000
38809,660
38810,1080
38811,9000
38812,720
38813,1200
38814,35
38815,70
38816,500
38822,360
38823,1000
38825,1000
38828,2000
38837,1500
38839,2800
38840,1000
38841,500
38842,800
38843,330
38844,330
38856,70
38857,110
38858,350
38859,2500
38878,3000
38880,650
25101,46500
25927,3500
61289,280
62817,1000
62818,1000
62823,1500
62824,1500
62825,1500
62826,1500
62827,550
62905,
63420,3500
63421,3500
63422,3500
63423,3500
63424,3500
63465,1200
63466,1200
63467,1400
63468,1400
63469,1400
63470,1200
63471,1200
63472,1200
63473,1200
63475,170
63494,700
63523,2800
63524,2800
63525,2800
63550,1200
63551,1200
63552,1200
63558,1200
63560,1200
63561,1200
63562,1200
63564,250
63565,800
63566,1200
63810,1200
63811,1200
63812,1200
63813,1200
63814,900
63825,2800
63826,2800
63840,1500
63841,1500
63842,600
63861,1200
63862,1200
63863,1200
63875,2800
63876,2800
63888,250
63889,250
64206,2500
64213,1200
64214,1200
64215,1200
64216,600
64219,800
19861,76500
19696,14450
19858,9350
19862,1700
19698,1280
19725,1200
19761,880
19730,800
19763,800
19724,640
19762,640
19697,640
19717,640
19745,640
19706,640
19728,600
19706,600
19699,600
19700,600
19769,600
19760,560
19797,560
19939,560
19702,560
19707,560
19729,560
19733,560
19701,400
19770,400
19863,350
19864,350
19865,350
19300,8418
19516,1830
19517,1403
19518,51000
19519,1403
19520,13157
19521,11342
19522,183
19523,3111
19524,53665
19525,610
19528,610
19529,8418
19530,34610
19531,29230
19532,427
19535,2562
19538,2562
19539,1037
19540,7320
19541,4514
19542,15555
19544,7320
19546,7320
19547,7320
19549,1403
19550,7320
19584,57800
19585,51000
19587,2562
19590,183
19593,1830
19594,1830
19595,15555
19657,15555
19658,7320
19659,4514
19686,57800
19687,51000
19689,2013
R241-7025,366
R241-7038,488
R241-7054,122
R261-7146,183
R360-775,610
Z2019,61
Z2021,61
Z2032,61
RM-24933,320
19600,102000
19602,2806
19603,1586
19605,22684
19606,29230
19607,2013
19608,2623
19609,2440
19610,3233
19611,4636
19613,1891
19614,1464
19615,1525
19616,1403
19619,1525
19620,25601
19621,1403
19622,1525
19623,77775
19624,14324
19626,2135
19627,40573
19632,1708
19633,1708
19635,1830
19636,1830
19637,15425
19638,3111
19639,3111
19640,1281
19641,3111
19642,6710
19643,1464
19644,1464
19645,1403
19646,1403
19649,1891
19650,1403
19651,1281
19652,18536
19653,87691
19688,10953
19771,1403
19772,1403
19786,1403
19787,1403
19788,1403
19789,1403
19790,1403
19791,1403
19792,1403
19793,5612
19794,1403
19803,29230
19938,20157
27918,40575
27935,6800
27936,6200
27937,7750
27939,1525
27940,2135
27941,1525
27942,1525
22321,1000
629052,500
70568,7000
22374,15000
22371,200
22373,500
70388,1250
        `;

        const partCosts = {};
        function initCostDatabase() {
            const lines = rawCostCSV.trim().split('\n');
            let partIdx = -1, costIdx = -1;
            for (let i = 0; i < lines.length; i++) {
                const cols = lines[i].split(',').map(c => c.trim().toUpperCase());
                if (i === 0 || partIdx === -1) {
                    partIdx = cols.findIndex(c => c.includes('PART NUMBER') || c.includes('PART NO'));
                    costIdx = cols.findIndex(c => c.includes('é€²è²¨åƒ¹') || c.includes('COST'));
                    if (partIdx === -1 && cols.length >= 2) { partIdx = 0; costIdx = cols.length - 1; if(cols.includes('é€²è²¨åƒ¹')) costIdx = cols.indexOf('é€²è²¨åƒ¹'); }
                    continue;
                }
                if (cols.length > Math.max(partIdx, costIdx)) {
                    const pNo = cols[partIdx];
                    const costStr = cols[costIdx] || "";
                    const cost = parseFloat(costStr.replace(/[^0-9.-]+/g, ""));
                    if (pNo && !isNaN(cost) && cost > 0) partCosts[pNo] = cost;
                }
            }
        }
        initCostDatabase();
    </script>

    <div class="container">
        <!-- æ¨™é ­ -->
        <div class="header no-print">
            <div class="title">
                <h1>æ°¸å®šç”Ÿç‰©ç§‘æŠ€ - æŠ€è¡“éƒ¨ KPI å„€è¡¨æ¿</h1>
                <p>V4.12 å°ˆæ¥­ BI æˆ°æƒ…å®¤ç‰ˆ | åˆ†é å°è¦½ã€å·¥ç¨‹å¸«çŸ©é™£ã€æˆæœ¬åŠ æ¬Šåˆ†æ</p>
            </div>
            <div>
                <button onclick="window.print()" style="padding: 10px 20px; background: #334155; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">ğŸ–¨ï¸ åˆ—å°ç‡Ÿé‹å ±å‘Š</button>
            </div>
        </div>

        <!-- é ‚éƒ¨éæ¿¾èˆ‡è¨­å®šå€ -->
        <div class="section no-print">
            <div class="controls">
                <div class="file-box" onclick="document.getElementById('csvFile').click()">
                    <input type="file" id="csvFile" accept=".csv" style="display: none" onchange="processFile(this.files[0])">
                    <div style="font-weight: bold; color: var(--primary);">ğŸ“‚ æ­¥é©Ÿ 1: ä¸Šå‚³ç¶­ä¿®ç´€éŒ„ CSV</div>
                    <div style="font-size: 0.8rem; color: #64748b;">(è‡ªå‹•è¨ˆç®—å·¥ä½œæ—¥èˆ‡ Pending å‰”é™¤)</div>
                </div>
                <div class="control-group"><label>é–‹å§‹æ—¥æœŸ</label><input type="date" id="startDate" onchange="recalc()"></div>
                <div class="control-group"><label>çµæŸæ—¥æœŸ</label><input type="date" id="endDate" onchange="recalc()"></div>
                <div class="control-group"><label>æ¯æœˆè²¬ä»»é»æ•¸</label><input type="number" id="targetPoints" value="150" onchange="recalc()"></div>
                <div class="control-group">
                    <label>æª”æ¡ˆç·¨ç¢¼</label>
                    <select id="encoding" onchange="if(lastFile) processFile(lastFile);">
                        <option value="UTF-8">UTF-8</option>
                        <option value="Big5">Big5 (Excel)</option>
                    </select>
                </div>
            </div>

            <!-- é»æ•¸è¨­å®š -->
            <details style="margin-top: 15px; cursor: pointer;">
                <summary style="font-size: 0.85rem; font-weight: bold; color: #9a3412;">âš™ï¸ é»æ•¸æ¬Šé‡è¨­å®š (é»æ“Šå±•é–‹/æ”¶åˆ)</summary>
                <div class="config-panel" style="margin-top: 10px;">
                    <div class="config-item"><span>ä¸€èˆ¬ç¶­ä¿®:</span><input type="number" id="pt_gen" value="2.0" step="0.5" onchange="recalc()"></div>
                    <div class="config-item"><span>å›°é›£ç¶­ä¿®:</span><input type="number" id="pt_hard" value="4.0" step="0.5" onchange="recalc()"></div>
                    <div class="config-item"><span>å±…å®¶ä¿é¤Š:</span><input type="number" id="pt_home" value="2.0" step="0.5" onchange="recalc()"></div>
                    <div class="config-item"><span>é†«é™¢ä¿é¤Š:</span><input type="number" id="pt_hosp_maint" value="1.0" step="0.5" onchange="recalc()"></div>
                    <div class="config-item"><span>ç°¡æ˜“æª¢æ¸¬:</span><input type="number" id="pt_chk" value="0.5" step="0.1" onchange="recalc()"></div>
                    <div class="config-item"><span>å¤–ä¿®åˆ¤å®š:</span><input type="number" id="pt_ext" value="1.0" step="0.5" onchange="recalc()"></div>
                    <div class="config-item"><span>æ‰¹é‡æ•´æ–°:</span><input type="number" id="pt_ref" value="1.5" step="0.5" onchange="recalc()"></div>
                    <div class="config-item"><span>å±…å®¶è£æ©Ÿ:</span><input type="number" id="pt_ins" value="2.5" step="0.5" onchange="recalc()"></div>
                    <div class="config-item"><span>é†«é™¢å®‰è£:</span><input type="number" id="pt_hosp_ins" value="2.0" step="0.5" onchange="recalc()"></div>
                    <div class="config-item"><span>ç¡çœ ä¸­å¿ƒ:</span><input type="number" id="pt_ctr" value="8.0" step="0.5" onchange="recalc()"></div>
                    <div class="config-item"><span>å…¶ä»–é è¨­:</span><input type="number" id="pt_def" value="1.0" step="0.1" onchange="recalc()"></div>
                </div>
            </details>
            <div id="statusMsg" style="margin-top: 10px; color: var(--primary); font-weight: bold; min-height: 20px;">ç­‰å¾…è³‡æ–™åŒ¯å…¥...</div>
        </div>

        <div id="dashboard" style="display: none;">
            
            <div style="text-align: center; margin-bottom: 10px;">
                <div id="reportRange" style="color: #64748b; font-size: 0.95rem; font-weight: bold;"></div>
            </div>

            <!-- å…¨å±€ KPI å¡ç‰‡ -->
            <div class="strategic-row">
                <div class="kpi-card" style="border-left-color: #8b5cf6;">
                    <div class="kpi-label">ğŸ’° é ä¼°éƒ¨é–€ç¶­ä¿®æ¯›åˆ© (NT$)</div>
                    <div class="kpi-val" id="grossMargin">0</div>
                    <div class="kpi-sub" id="financialDetail">æ”¶è²»: 0 | å¤–ä¿®: 0 | é›¶ä»¶: 0</div>
                </div>
                <div class="kpi-card" style="border-left-color: #f43f5e; position: relative;">
                    <div class="kpi-label" title="ä»¥å·¥ä½œæ—¥è¨ˆç®—ï¼Œå·²æ‰£é™¤å¾…æ–™">â³ SLA æœå‹™è¶…æ¨™ç‡ (TAT > 5æ—¥)</div>
                    <div class="kpi-val" id="slaOutlierRate">0%</div>
                    <div class="kpi-sub" style="cursor:pointer; color:var(--accent); text-decoration:underline; font-weight:bold;" onclick="openSlaModal()" id="slaDetail">
                        è¶…æ¨™ä»¶æ•¸: 0 ä»¶ (æŸ¥çœ‹æ˜ç´°)
                    </div>
                </div>
                <div class="kpi-card" style="border-left-color: #0ea5e9;">
                    <div class="kpi-label">ğŸ›¡ï¸ ä¿å›ºå…§æ¡ˆä»¶ä½”æ¯”</div>
                    <div class="kpi-val" id="warrantyRate">0%</div>
                    <div class="kpi-sub" id="warrantyDetail">ä¿å›ºå…§ä»¶æ•¸: 0 ä»¶</div>
                </div>
            </div>

            <div class="kpi-row">
                <div class="kpi-card" style="border-left-color: #3b82f6;">
                    <div class="kpi-label">å®Œä¿®ç¸½æ•¸ (Workload)</div>
                    <div class="kpi-val" id="totalUnique">0</div>
                    <div class="kpi-sub">(å«ä¿é¤Šè£æ©Ÿ)</div>
                </div>
                <div class="kpi-card" style="border-left-color: #0d9488;">
                    <div class="kpi-label">å‡ TAT (æ‰£é™¤å¾…æ–™)</div>
                    <div class="kpi-val" id="avgTat">0 å¤©</div>
                    <div class="kpi-sub" id="pendingSaved">å·²æ‰£é™¤ç­‰å¾…æœŸ: 0å¤©</div>
                </div>
                <div class="kpi-card" style="border-left-color: #d97706;">
                    <div class="kpi-label">å¹³å‡å¾…ä¿®æ™‚é•· (ç®¡ç†)</div>
                    <div class="kpi-val" id="avgBacklog">0 å¤©</div>
                    <div class="kpi-sub">(åˆè™•~ç¶­ä¿® - å¾…æ–™æœŸ)</div>
                </div>
                <div class="kpi-card" style="border-left-color: #14b8a6;">
                    <div class="kpi-label">å¹³å‡æ–½å·¥å¤©æ•¸ (æŠ€è¡“)</div>
                    <div class="kpi-val" id="avgConstDays">0 å¤©</div>
                    <div class="kpi-sub">(ç´”æ–½å·¥æ•ˆç‡)</div>
                </div>
                <div class="kpi-card" style="border-left-color: #10b981;">
                    <div class="kpi-label">ğŸ¯ é¦–æ¬¡ä¿®å¾©ç‡ (FTF)</div>
                    <div class="kpi-val" id="ftfRate">100%</div>
                    <div class="kpi-sub">(ç„¡è¿”ä¿®æ¡ˆä»¶æ¯”ä¾‹)</div>
                </div>
                <div class="kpi-card" style="border-left-color: #22c55e;">
                    <div class="kpi-label">ç¸½ç¸¾æ•ˆé»æ•¸</div>
                    <div class="kpi-val" id="totalPoints">0</div>
                    <div class="kpi-sub">(éƒ¨é–€ç¸½ç”¢èƒ½)</div>
                </div>
            </div>

            <!-- V4.12 å°èˆªåˆ†é  -->
            <div class="tabs-container no-print">
                <button class="tab-btn active" onclick="switchTab('tab-overview', this)">ğŸ“Š ç‡Ÿé‹ç¸½è¦½èˆ‡ç•°å¸¸åˆ†æ</button>
                <button class="tab-btn" onclick="switchTab('tab-engineer', this)">ğŸ‘¨â€ğŸ”§ å·¥ç¨‹å¸«ç¸¾æ•ˆèˆ‡çŸ©é™£</button>
                <button class="tab-btn" onclick="switchTab('tab-parts', this)">ğŸ“¦ é›¶ä»¶èˆ‡æˆæœ¬è¿½è¹¤</button>
                <button class="tab-btn" onclick="switchTab('tab-customers', this)">ğŸ¤ å®¢æˆ¶æ´å¯Ÿ (Top 5)</button>
            </div>

            <!-- ================= Tab 1: ç‡Ÿé‹ç¸½è¦½ ================= -->
            <div id="tab-overview" class="tab-content active">
                <div class="section">
                    <div class="header" style="border-bottom:none; margin-bottom:10px; padding-bottom:0;">
                        <h3 style="margin:0;">ğŸ“Š ç¶­ä¿®æœå‹™é‡è¶¨å‹¢èˆ‡çµæ§‹</h3>
                        <div class="chart-controls no-print">
                            <div id="filterNotice" onclick="clearDrillDown()">ğŸ”„ ç¯©é¸ä¸­: é»æ­¤æ¸…é™¤</div>
                            <div class="chart-btn-group">
                                <button class="chart-btn active" onclick="updateChartGranularity('month', this)">ä¾æœˆ</button>
                                <button class="chart-btn" onclick="updateChartGranularity('quarter', this)">ä¾å­£</button>
                                <button class="chart-btn" onclick="updateChartGranularity('year', this)">ä¾å¹´</button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="font-size:0.8rem; color:#64748b; margin-bottom:15px; text-align:right;">(æç¤ºï¼šé»æ“Šä¸‹æ–¹é•·æ¢åœ–ï¼Œå¯é€£å‹•ç¯©é¸ä¸‹æ–¹æ‰€æœ‰è¦–è¦ºåœ–è¡¨èˆ‡æ•¸æ“š)</div>

                    <div class="chart-container" style="height: 350px; margin-bottom: 20px;"><canvas id="serviceChart"></canvas></div>
                    
                    <div class="chart-grid-bottom">
                        <div>
                            <h4 style="margin:0 0 10px 0; text-align:center; color:#64748b; font-size:0.9rem;">SLA æ™‚æ•ˆåˆ†ä½ˆ (æ·¨å·¥ä½œæ—¥)</h4>
                            <div class="chart-container" style="height: 250px;"><canvas id="tatChart"></canvas></div>
                        </div>
                        <div>
                            <h4 style="margin:0 0 10px 0; text-align:center; color:#64748b; font-size:0.9rem;">ä¿å›ºå…§å¤–æ¡ˆä»¶ä½”æ¯”</h4>
                            <div class="chart-container" style="height: 250px;"><canvas id="warrantyChart"></canvas></div>
                        </div>
                        <div>
                            <h4 style="margin:0 0 10px 0; text-align:center; color:#64748b; font-size:0.9rem;">Top 5 é«˜é »é€²å ´æ©Ÿå‹ (ç´”ç¶­ä¿®é¡)</h4>
                            <div class="chart-container" style="height: 250px;"><canvas id="modelChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- ç•°å¸¸èˆ‡ä¿å›ºæ·±åº¦åˆ†æ + è¤‡é¸äº¤å‰ç¯©é¸ -->
                <div class="section">
                    <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:15px; flex-wrap:wrap; gap:15px;">
                        <div>
                            <h3 style="margin:0; color:#1e293b;">ğŸ” ç•°å¸¸èˆ‡æˆæœ¬çµæ§‹æ·±åº¦åˆ†æ (SLA & ä¿å›º)</h3>
                            <p style="margin: 5px 0 0; color:#64748b; font-size:0.9rem;">(é»æ“Šåœ“é¤…åœ–å€å¡Šå¯æŸ¥çœ‹è©²åˆ†é¡æ˜ç´°èˆ‡ AI æ´å¯Ÿ)</p>
                        </div>
                        <div style="display:flex; gap:10px; align-items:flex-end;">
                            <div>
                                <label style="display:block; font-size:0.8rem; color:#475569; font-weight:bold; margin-bottom:4px;">ç¯©é¸æ©Ÿå‹</label>
                                <select id="subFilterModel" onchange="renderDeepAnalysisCharts()" style="padding:6px; border-radius:6px; border:1px solid #cbd5e1; font-size:0.9rem; min-width:140px; background:white;">
                                    <option value="ALL">å…¨éƒ¨æ©Ÿå‹</option>
                                </select>
                            </div>
                            <div style="position: relative;">
                                <label style="display:block; font-size:0.8rem; color:#475569; font-weight:bold; margin-bottom:4px;">ç¯©é¸åˆ†é¡ (è¤‡é¸)</label>
                                <div id="typeMultiSelect" class="multi-select-box" onclick="toggleTypeMenu(event)">
                                    <span id="typeMultiSelectText">å…¨éƒ¨åˆ†é¡</span>
                                    <span style="font-size: 0.7rem; color: #94a3b8;">â–¼</span>
                                </div>
                                <div id="typeMultiSelectMenu" class="multi-select-menu">
                                    <label style="border-bottom: 1px solid #e2e8f0; padding-bottom: 6px; margin-bottom: 4px;">
                                        <input type="checkbox" id="typeSelectAll" checked onchange="toggleAllTypes(this)"> <strong>å…¨é¸ / å–æ¶ˆå…¨é¸</strong>
                                    </label>
                                    <div id="subFilterTypeContainer"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-grid-bottom" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px;">
                        <div style="background:#fff1f2; padding:15px; border-radius:8px; border:1px solid #fecdd3;">
                            <h4 style="margin:0 0 10px 0; text-align:center; color:#be123c; font-size:0.9rem;">ğŸš¨ SLAé€¾æœŸ - æœå‹™åˆ†é¡</h4>
                            <div class="chart-container" style="height: 200px;"><canvas id="slaTypeChart"></canvas></div>
                        </div>
                        <div style="background:#fff1f2; padding:15px; border-radius:8px; border:1px solid #fecdd3;">
                            <h4 style="margin:0 0 10px 0; text-align:center; color:#be123c; font-size:0.9rem;">ğŸš¨ SLAé€¾æœŸ - é«˜é »æ©Ÿå‹</h4>
                            <div class="chart-container" style="height: 200px;"><canvas id="slaModelChart"></canvas></div>
                        </div>
                        <div style="background:#f0f9ff; padding:15px; border-radius:8px; border:1px solid #bae6fd;">
                            <h4 style="margin:0 0 10px 0; text-align:center; color:#0369a1; font-size:0.9rem;">ğŸ›¡ï¸ ä¿å›ºå…§ - æœå‹™åˆ†é¡</h4>
                            <div class="chart-container" style="height: 200px;"><canvas id="warTypeChart"></canvas></div>
                        </div>
                        <div style="background:#f0f9ff; padding:15px; border-radius:8px; border:1px solid #bae6fd;">
                            <h4 style="margin:0 0 10px 0; text-align:center; color:#0369a1; font-size:0.9rem;">ğŸ›¡ï¸ ä¿å›ºå…§ - æ©Ÿå‹åˆ†ä½ˆ</h4>
                            <div class="chart-container" style="height: 200px;"><canvas id="warModelChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- ç¶“ç†äººæ–‡å­—åˆ†æå€å¡Š -->
                <div class="section">
                    <div class="analysis-grid" style="margin-top:0;">
                        <div class="analysis-box" style="border-top: 4px solid #8b5cf6;">
                            <div class="analysis-title">ğŸ’¼ è²¡å‹™èˆ‡é•·æœŸé¢¨éšªè©•ä¼°</div>
                            <div class="analysis-content" id="textStrategic">è¨ˆç®—ä¸­...</div>
                        </div>
                        <div class="analysis-box" style="border-top: 4px solid #f59e0b;">
                            <div class="analysis-title">ğŸ’¡ ç‡Ÿé‹æ±ºç­–èˆ‡è¡Œå‹•å»ºè­°</div>
                            <div class="analysis-content" id="textAction">è¨ˆç®—ä¸­...</div>
                        </div>
                        <div class="analysis-box" style="border-top: 4px solid #22c55e;">
                            <div class="analysis-title">ğŸ“ ç¸¾æ•ˆç¸½çµé€Ÿè¨˜ (ä¾›æœƒè­°ä½¿ç”¨)</div>
                            <div class="analysis-content" id="textSummary">è¨ˆç®—ä¸­...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= Tab 2: å·¥ç¨‹å¸«ç¸¾æ•ˆ ================= -->
            <div id="tab-engineer" class="tab-content">
                <div class="section">
                    <h3 style="margin-top: 0;">ğŸ¯ åœ˜éšŠç”¢èƒ½èˆ‡æ•ˆç‡çŸ©é™£ (Scatter Plot)</h3>
                    <p style="font-size:0.9rem; color:#64748b; margin-bottom:15px;">(Xè»¸: ç”¢èƒ½é»æ•¸ï¼ŒYè»¸: å¹³å‡æ™‚æ•ˆï¼Œæ°£æ³¡å¤§å°: è¿”ä¿®ç‡ã€‚å³ä¸‹è§’ç‚ºæœ€ç†æƒ³æˆ°åŠ›)</p>
                    <div class="chart-container" style="height: 400px; background:#f8fafc; border-radius:8px; padding:10px;"><canvas id="engBubbleChart"></canvas></div>
                </div>

                <div class="section">
                    <h3 style="margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px;">å·¥ç¨‹å¸« KPI è©•åˆ†è¡¨ <span style="font-size:0.8rem; color:#64748b; font-weight:normal;">(é»æ“Šå§“åå¯æŸ¥çœ‹æ˜ç´°)</span></h3>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th rowspan="2" style="font-size: 1rem;">å·¥ç¨‹å¸«</th>
                                    <th colspan="3" style="text-align: center; background: #e0f2fe;">å·¥ä½œé‡ (30%)</th>
                                    <th colspan="2" style="text-align: center; background: #ffedd5;">æ·¨æ™‚æ•ˆ TAT (30%)</th>
                                    <th colspan="2" style="text-align: center; background: #fee2e2;">å“è³ª RWO (20%)</th>
                                    <th colspan="1" style="text-align: center; background: #f3f4f6;">é…åˆåº¦ (20%)</th>
                                    <th rowspan="2" style="text-align: center; font-size: 1rem;">ç¸½åˆ†</th>
                                </tr>
                                <tr>
                                    <th>ç¸½æ¡ˆ</th>
                                    <th>é»æ•¸</th>
                                    <th>é”æˆç‡</th>
                                    <th>å‡ TAT</th>
                                    <th>å¾—åˆ†</th>
                                    <th>è¿”ä¿®ç‡(ä»¶)</th>
                                    <th>å¾—åˆ†</th>
                                    <th style="width: 80px;">ä¸»ç®¡è©•åˆ†</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ================= Tab 3: é›¶ä»¶èˆ‡æˆæœ¬ ================= -->
            <div id="tab-parts" class="tab-content">
                <div class="section">
                    <div class="chart-grid-top" style="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));">
                        <div>
                            <h3 style="margin:0 0 10px 0; color:#1e293b;">ğŸ“¦ æ¶ˆè€—æ•¸é‡æ’è¡Œ Top 10</h3>
                            <div class="chart-container"><canvas id="partsChart"></canvas></div>
                        </div>
                        <div>
                            <h3 style="margin:0 0 10px 0; color:#be123c;">ğŸ’¸ ç¸½æˆæœ¬å½±éŸ¿æ’è¡Œ Top 10 (æ•¸é‡ Ã— é€²è²¨åƒ¹)</h3>
                            <div class="chart-container"><canvas id="partsCostChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 style="margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px;">ğŸ› ï¸ é›¶ä»¶æ¶ˆè€—é‡æ˜ç´° (å«æ–™è™Ÿèˆ‡æˆæœ¬é ä¼°)</h3>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">æ’å</th>
                                    <th style="width: 150px;">é›¶ä»¶è™Ÿç¢¼ (P/N)</th>
                                    <th>é›¶ä»¶åç¨± / èªªæ˜</th>
                                    <th style="width: 100px; text-align: right;">æ¶ˆè€—æ•¸é‡</th>
                                    <th style="width: 120px; text-align: right;">é ä¼°ç¸½æˆæœ¬</th>
                                    <th style="width: 200px;">æ•¸é‡ä½”æ¯”åœ–ç¤º</th>
                                </tr>
                            </thead>
                            <tbody id="partsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ================= Tab 4: å®¢æˆ¶æ´å¯Ÿ ================= -->
            <div id="tab-customers" class="tab-content">
                <div class="section">
                    <h3 style="margin:0; color:#1e293b;">ğŸ† é‡é»å®¢æˆ¶/å–®ä½å«ä¿®åˆ†æ (Top 5)</h3>
                    <p style="margin: 5px 0 10px; color:#64748b; font-size:0.9rem;">(é‡å°ç´”ç¶­ä¿®/æª¢æ¸¬é¡æ¡ˆä»¶ï¼Œåˆ†ææœ€å¸¸å«ä¿®å–®ä½çš„æ•…éšœæ¨¡å¼èˆ‡é›¶ä»¶æ¶ˆè€—)</p>
                    <div id="topCustomersList" class="top-customer-grid">
                        <div style="text-align:center; color:#999; grid-column: 1/-1; padding:20px;">è³‡æ–™è¨ˆç®—ä¸­...</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal å½ˆå‡ºè¦–çª— -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle" style="margin-top: 0; border-bottom: 2px solid var(--primary); padding-bottom: 10px; color: var(--primary);">æ¡ˆä»¶æ˜ç´°</h2>
            <div id="modalAnalysisText" style="margin-bottom: 15px; padding: 15px; background: #f0fdf4; border: 1px solid #10b981; border-radius: 8px; font-size: 0.95rem; line-height: 1.6; color: #064e3b; display: none;"></div>
            <div class="table-responsive">
                <table style="font-size: 0.85rem;">
                    <thead>
                        <tr>
                            <th>å·¥å–®è™Ÿç¢¼</th>
                            <th>å®Œæˆæ—¥æœŸ</th>
                            <th>æ©Ÿå‹</th>
                            <th>åºè™Ÿ</th>
                            <th>ç¸½å¤©æ•¸</th>
                            <th>æ·¨TAT</th>
                            <th>ç‹€æ…‹</th>
                            <th>ç¶­ä¿®é¡å‹</th>
                            <th>é»æ•¸</th>
                            <th>æ›´æ›é›¶ä»¶</th>
                        </tr>
                    </thead>
                    <tbody id="modalBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // DOM Safe Updates to prevent "Cannot set properties of null"
        const safeSetText = (id, text) => { const el = document.getElementById(id); if (el) el.innerText = text; };
        const safeSetHtml = (id, html) => { const el = document.getElementById(id); if (el) el.innerHTML = html; };
        const safeSetStyle = (id, prop, val) => { const el = document.getElementById(id); if (el) el.style[prop] = val; };

        // V4.12 å°èˆªåˆ†é åˆ‡æ›é‚è¼¯ (Fixes Chart.js rendering on hidden tabs)
        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');

            // Force resize charts in the newly active tab
            setTimeout(() => {
                if (tabId === 'tab-overview') {
                    if (serviceChartInstance) serviceChartInstance.resize();
                    if (tatChartInstance) tatChartInstance.resize();
                    if (warrantyChartInstance) warrantyChartInstance.resize();
                    if (modelChartInstance) modelChartInstance.resize();
                    if (slaTypeChartInst) slaTypeChartInst.resize();
                    if (slaModelChartInst) slaModelChartInst.resize();
                    if (warTypeChartInst) warTypeChartInst.resize();
                    if (warModelChartInst) warModelChartInst.resize();
                } else if (tabId === 'tab-engineer') {
                    if (engBubbleChartInst) engBubbleChartInst.resize();
                } else if (tabId === 'tab-parts') {
                    if (partsChartInstance) partsChartInstance.resize();
                    if (partsCostChartInstance) partsCostChartInstance.resize();
                }
            }, 50);
        }

        let lastFile = null;
        let uniqueCases = [];
        let globalFilteredCases = []; 
        let currentDisplayCases = []; 
        
        // Chart Instances
        let serviceChartInstance = null;
        let partsChartInstance = null;
        let partsCostChartInstance = null; 
        let engBubbleChartInst = null; 
        let modelChartInstance = null;
        let tatChartInstance = null; 
        let warrantyChartInstance = null;
        let slaTypeChartInst = null;
        let slaModelChartInst = null;
        let warTypeChartInst = null;
        let warModelChartInst = null;

        let currentGranularity = 'month';
        let currentDrillDownLabel = null; 

        let reportData = {
            totalCases: 0, totalPoints: 0, recallRate: 0, recallNum: 0,
            revenue: 0, extCost: 0, partsCost: 0, warrantyCount: 0, tatOutliers: 0,
            avgTat: 0, avgBacklog: 0, avgConstDays: 0, totalPendingSaved: 0,
            serviceDistribution: {}, topPart: { name: "", count: 0 }, topModels: [],
            topEngineer: { name: "", points: 0 }, sortedPartsRaw: [], sortedPartsByCost: [], engDataForBubble: []
        };

        // Multi-Select Dropdown Logic
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('typeMultiSelectMenu');
            const box = document.getElementById('typeMultiSelect');
            if (menu && box && !menu.contains(e.target) && !box.contains(e.target)) {
                menu.classList.remove('active');
            }
        });

        function toggleTypeMenu(e) { 
            const menu = document.getElementById('typeMultiSelectMenu');
            if(menu) menu.classList.toggle('active'); 
        }
        function toggleAllTypes(source) {
            const checkboxes = document.querySelectorAll('.type-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateTypeSelectText();
            renderDeepAnalysisCharts();
        }
        function handleTypeChange() {
            const checkboxes = document.querySelectorAll('.type-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const selectAllElem = document.getElementById('typeSelectAll');
            if(selectAllElem) selectAllElem.checked = allChecked;
            updateTypeSelectText();
            renderDeepAnalysisCharts();
        }
        function updateTypeSelectText() {
            const checkboxes = document.querySelectorAll('.type-checkbox');
            const checkedBoxes = document.querySelectorAll('.type-checkbox:checked');
            const textSpan = document.getElementById('typeMultiSelectText');
            if(!textSpan) return;
            if (checkedBoxes.length === checkboxes.length || checkedBoxes.length === 0) textSpan.innerText = 'å…¨éƒ¨åˆ†é¡';
            else if (checkedBoxes.length === 1) textSpan.innerText = checkedBoxes[0].value;
            else textSpan.innerText = `å·²é¸ ${checkedBoxes.length} é …`;
        }

        function parseCSV_Robust(text) {
            let arr = []; let quote = false; let row = 0, col = 0, c = 0;
            arr[row] = []; arr[row][col] = "";
            for (c = 0; c < text.length; c++) {
                let cc = text[c], nc = text[c+1];
                arr[row] = arr[row] || []; arr[row][col] = arr[row][col] || "";
                if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; continue; }
                if (cc == '"') { quote = !quote; continue; }
                if (cc == ',' && !quote) { ++col; continue; }
                if (cc == '\r' && nc == '\n' && !quote) { ++row; col = 0; ++c; continue; }
                if (cc == '\n' && !quote) { ++row; col = 0; continue; }
                if (cc == '\r' && !quote) { ++row; col = 0; continue; }
                arr[row][col] += cc;
            }
            return arr;
        }

        function parseDate(s) { 
            if(!s) return null; 
            const d = new Date(s); 
            if (isNaN(d.getTime())) return null; 
            d.setHours(0,0,0,0);
            return d; 
        }

        function getWorkingDays(startDate, endDate) {
            if (!startDate || !endDate) return 0;
            if (startDate > endDate) return 0;
            let count = 0;
            let curDate = new Date(startDate.getTime());
            while (curDate <= endDate) {
                const dayOfWeek = curDate.getDay();
                if(dayOfWeek !== 0 && dayOfWeek !== 6) count++;
                curDate.setDate(curDate.getDate() + 1);
            }
            return Math.max(1, count);
        }

        function processFile(file) {
            if (!file) return;
            lastFile = file;
            const encoding = document.getElementById('encoding').value;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = parseCSV_Robust(text);
                const headers = rows[0].map(h => h.trim().replace(/^[\uFEFF]/, ''));
                
                const map = {
                    id: headers.findIndex(h => h.includes('å·¥å–®') || h.includes('Order') || h.includes('ID')),
                    eng: headers.findIndex(h => h.includes('å·¥ç¨‹å¸«') || h.includes('Engineer')),
                    client: headers.findIndex(h => h.includes('å®¢æˆ¶åç¨±') || h.includes('Customer')), 
                    
                    date_recv: headers.findIndex(h => h === 'æ”¶åˆ°æ—¥æœŸ' || h.includes('æ”¶åˆ°æ—¥æœŸ')),
                    date_first: headers.findIndex(h => h === 'åˆæ­¥è™•ç†æ—¥æœŸ' || h.includes('åˆæ­¥è™•ç†')),
                    date_quote: headers.findIndex(h => h === 'å ±åƒ¹æ—¥æœŸ' || h.includes('å ±åƒ¹æ—¥æœŸ')),
                    date_repair: headers.findIndex(h => h === 'ç¶­ä¿®æ—¥æœŸ' || h.includes('ç¶­ä¿®æ—¥æœŸ')),
                    date_finish: headers.findIndex(h => h === 'å®Œæˆæ—¥æœŸ' || h.includes('å®Œæˆæ—¥æœŸ')),
                    workDaysCol: headers.findIndex(h => h === 'æ–½å·¥å¤©æ•¸' || h.includes('æ–½å·¥å¤©æ•¸')),
                    tat: headers.findIndex(h => h.includes('å·¥ä½œå¤©æ•¸') || h.includes('Days')),

                    type: headers.findIndex(h => h.includes('ç¶­ä¿®æœå‹™é¸é …') || h.includes('Service') || h.includes('ç¶­ä¿®é¡åˆ¥')),
                    req: headers.findIndex(h => h === 'éœ€æ±‚' || h.includes('éœ€æ±‚')),
                    model: headers.findIndex(h => h.includes('æ©Ÿå‹') || h.includes('Model')),
                    sn: headers.findIndex(h => h.includes('åºè™Ÿ') || h.includes('S/N') || h.includes('Serial')),
                    fault: headers.findIndex(h => h.includes('æ•…éšœæƒ…æ³') || h.includes('Fault') || h.includes('Problem')), 
                    revenue: headers.findIndex(h => h === 'æ”¶è²»é‡‘é¡' || h.includes('æ”¶è²»é‡‘é¡') || h === 'æ”¶è²»ç¸½è¨ˆ'),
                    extCost: headers.findIndex(h => h === 'å¤–ä¿®é‡‘é¡' || h.includes('å¤–ä¿®é‡‘é¡')),
                    part1: headers.findIndex(h => h.includes('é›¶ä»¶èªªæ˜1')), partNo1: headers.findIndex(h => h.includes('é›¶ä»¶è™Ÿç¢¼1')),
                    part2: headers.findIndex(h => h.includes('é›¶ä»¶èªªæ˜2')), partNo2: headers.findIndex(h => h.includes('é›¶ä»¶è™Ÿç¢¼2')),
                    part3: headers.findIndex(h => h.includes('é›¶ä»¶èªªæ˜3')), partNo3: headers.findIndex(h => h.includes('é›¶ä»¶è™Ÿç¢¼3')),
                    part4: headers.findIndex(h => h.includes('é›¶ä»¶èªªæ˜4')), partNo4: headers.findIndex(h => h.includes('é›¶ä»¶è™Ÿç¢¼4')),
                    partGen: headers.findIndex(h => h.includes('é›¶ä»¶èªªæ˜') && !h.includes('1')), partNoGen: headers.findIndex(h => h.includes('é›¶ä»¶è™Ÿç¢¼') && !h.includes('1'))
                };

                if (map.eng === -1 || map.date_finish === -1) { alert("âš ï¸ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ã€Œå·¥ç¨‹å¸«ã€æˆ–ã€Œå®Œæˆæ—¥æœŸã€æ¬„ä½ã€‚"); return; }

                const caseMap = new Map();
                let lastValidID = null, lastValidDate = null, lastValidEng = null;

                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.length < 2) continue;

                    let id = (row[map.id] || "").trim();
                    let eng = (row[map.eng] || "").trim();
                    let sn = (row[map.sn] || "").trim();
                    let client = map.client > -1 ? (row[map.client] || "").trim() : "Unknown"; 
                    
                    if (!id && lastValidID) id = lastValidID; else if (id) lastValidID = id; else continue;
                    if (!eng && lastValidEng) eng = lastValidEng; else if (eng && !eng.includes("Assembly")) lastValidEng = eng;
                    if (!eng || eng.length > 20 || eng.includes("Assembly")) continue;

                    let dRecv = map.date_recv > -1 ? parseDate(row[map.date_recv]) : null;
                    let dFirst = map.date_first > -1 ? parseDate(row[map.date_first]) : null;
                    let dQuote = map.date_quote > -1 ? parseDate(row[map.date_quote]) : null;
                    let dRepair = map.date_repair > -1 ? parseDate(row[map.date_repair]) : null;
                    let dFinish = map.date_finish > -1 ? parseDate(row[map.date_finish]) : null;
                    let constDays = map.workDaysCol > -1 ? parseFloat(row[map.workDaysCol]) || 0 : 0;

                    if (!dFinish && lastValidDate && id === lastValidID) dFinish = lastValidDate; else if (dFinish) lastValidDate = dFinish;
                    if (!dRecv && dFinish) dRecv = dFinish;

                    let pendingDays = 0;
                    if (dQuote && dRepair && dRepair >= dQuote) {
                        pendingDays = getWorkingDays(dQuote, dRepair) - 1; 
                        if (pendingDays < 0) pendingDays = 0;
                    }

                    let rawTat = 0;
                    if (dRecv && dFinish) {
                        rawTat = getWorkingDays(dRecv, dFinish);
                    } else {
                        rawTat = parseFloat(row[map.tat]) || 0;
                    }

                    let effTat = Math.max(1, rawTat - pendingDays);

                    let backlogDays = 0;
                    if (dFirst && dRepair && dRepair >= dFirst) {
                        backlogDays = Math.max(0, getWorkingDays(dFirst, dRepair) - 1 - pendingDays);
                    }

                    const type = (row[map.type] || "").trim();
                    const model = (row[map.model] || "").trim();
                    const fault = map.fault > -1 ? (row[map.fault] || "").trim() : ""; 

                    let revStr = map.revenue > -1 ? row[map.revenue] : "0";
                    let extStr = map.extCost > -1 ? row[map.extCost] : "0";
                    let reqStr = map.req > -1 ? (row[map.req] || "").trim() : "";
                    
                    let revAmt = parseFloat((revStr || "0").replace(/[^0-9.-]+/g, "")) || 0;
                    let extAmt = parseFloat((extStr || "0").replace(/[^0-9.-]+/g, "")) || 0;
                    let isWarranty = reqStr.includes("ä¿å›º") || reqStr.includes("ç¶­è­·åˆç´„");

                    const parts = [];
                    const addPart = (idxName, idxNo) => {
                        if (idxName > -1 && row[idxName]) {
                            const pName = row[idxName].trim(); const pNo = (idxNo > -1 && row[idxNo]) ? row[idxNo].trim() : "";
                            if (pName) parts.push({ name: pName, no: pNo });
                        }
                    };
                    addPart(map.part1, map.partNo1); addPart(map.part2, map.partNo2); addPart(map.part3, map.partNo3); addPart(map.part4, map.partNo4); addPart(map.partGen, map.partNoGen);

                    if (!caseMap.has(id)) {
                        caseMap.set(id, {
                            id: id, engineer: eng, date: dFinish, sn: sn,
                            type: type, model: model, parts: parts, client: client, fault: fault, 
                            req: reqStr, 
                            rawTat: rawTat, tat: effTat, pendingDays: pendingDays, 
                            backlogDays: backlogDays, constDays: constDays, 
                            revenue: revAmt, extCost: extAmt, warranty: isWarranty,
                            isRecall: false, recallReason: "", recallRef: ""
                        });
                    } else {
                        const existing = caseMap.get(id);
                        if (effTat > existing.tat) {
                            existing.tat = effTat; existing.rawTat = rawTat; 
                            existing.pendingDays = pendingDays; existing.backlogDays = backlogDays; existing.constDays = constDays;
                        }
                        if (eng && !existing.engineer) existing.engineer = eng;
                        if (sn && !existing.sn) existing.sn = sn;
                        if (model && !existing.model) existing.model = model;
                        if (revAmt > existing.revenue) existing.revenue = revAmt;
                        if (extAmt > existing.extCost) existing.extCost = extAmt;
                        if (isWarranty) existing.warranty = true;
                        if (reqStr) existing.req = reqStr; 
                        
                        parts.forEach(p => {
                            const exists = existing.parts.some(ep => ep.name === p.name && ep.no === p.no);
                            if (!exists) existing.parts.push(p);
                        });
                    }
                }

                uniqueCases = Array.from(caseMap.values());
                uniqueCases.sort((a, b) => (a.date || 0) - (b.date || 0));
                
                const snHistory = {};
                uniqueCases.forEach(c => {
                    const sn = c.sn.toUpperCase();
                    if (!sn || sn.length < 3 || sn === "ç„¡" || sn === "N/A" || sn === "NA" || sn.includes("#N/A")) return;
                    if (snHistory[sn]) {
                        const prevCases = snHistory[sn];
                        const lastCase = prevCases[prevCases.length - 1];
                        if (c.date && lastCase.date) {
                            const diffDays = Math.ceil(Math.abs(c.date - lastCase.date) / (1000 * 60 * 60 * 24)); 
                            if (diffDays <= 14 && isRepairType(c.type) && isRepairType(lastCase.type)) {
                                c.isRecall = true; c.recallReason = `14å¤©å…§ (${diffDays}å¤©)`; c.recallRef = lastCase.id;
                            }
                        }
                        prevCases.push(c);
                    } else { snHistory[sn] = [c]; }
                });
                
                const validDates = uniqueCases.map(c => c.date).filter(d => d).sort((a,b) => a-b);
                if (validDates.length > 0) {
                    const lastDateObj = validDates[validDates.length-1];
                    const y = lastDateObj.getFullYear();
                    const m = String(lastDateObj.getMonth() + 1).padStart(2, '0');
                    const d = String(lastDateObj.getDate()).padStart(2, '0');
                    safeSetText('startDate', `${y}-${m}-01`);
                    safeSetText('endDate', `${y}-${m}-${d}`);
                    // update input values as well
                    const sInp = document.getElementById('startDate'); if(sInp) sInp.value = `${y}-${m}-01`;
                    const eInp = document.getElementById('endDate'); if(eInp) eInp.value = `${y}-${m}-${d}`;
                }
                safeSetText('statusMsg', `âœ… æˆåŠŸè®€å– ${uniqueCases.length} ç­†å·¥å–®ã€‚`);
                safeSetStyle('dashboard', 'display', 'block');
                recalc();
            };
            reader.readAsText(file, encoding);
        }

        function isRepairType(t) { return (t||"").includes("æª¢æ¸¬") || (t||"").includes("ç¶­ä¿®") || (t||"").includes("å¤–ä¿®"); }
        function mapType(t) {
            t = t||"";
            if(t.includes("å›°é›£")) return "å›°é›£ç¶­ä¿®"; if(t.includes("ç¡çœ ä¸­å¿ƒ")) return "ç¡çœ ä¸­å¿ƒ";
            if(t.includes("é†«é™¢è¨­å‚™å®‰è£")||t.includes("é†«é™¢è£æ©Ÿ")) return "é†«é™¢å®‰è£"; if(t.includes("è¨­å‚™è£æ©Ÿ")||t.includes("å±…å®¶è£æ©Ÿ")) return "å±…å®¶è£æ©Ÿ";
            if(t.includes("é†«é™¢ä¿é¤Š")) return "é†«é™¢ä¿é¤Š"; if(t.includes("å±…å®¶ä¿é¤Š")) return "å±…å®¶ä¿é¤Š";
            if(t.includes("ä¸€èˆ¬")||t.includes("å…§ä¿®")) return "ä¸€èˆ¬ç¶­ä¿®"; if(t.includes("æ•´æ–°")) return "æ‰¹é‡æ•´æ–°";
            if(t.includes("å¤–ä¿®")) return "å¤–ä¿®åˆ¤å®š"; if(t.includes("æª¢æ¸¬")||t.includes("ç°¡æ˜“")) return "ç°¡æ˜“æª¢æ¸¬";
            return "å…¶ä»–é è¨­";
        }
        function updateRowScore(inp, sT, sP, sR) {
            const newCoop = parseFloat(inp.value) || 0;
            const finalScore = (sT * 0.3) + (sP * 0.3) + (sR * 0.2) + (newCoop * 0.2);
            const cell = inp.closest('tr').querySelector('td:last-child');
            if(cell) {
                cell.innerText = finalScore.toFixed(0);
                cell.style.color = "#d97706"; setTimeout(() => { cell.style.color = "#0f172a"; }, 500);
            }
        }

        function generateTopCustomersReport(filteredCases) {
            const custMap = {};
            filteredCases.forEach(c => {
                const t = c.type || "";
                const isRoutine = ["ä¿é¤Š", "æ•´æ–°", "è£æ©Ÿ", "å®‰è£"].some(k => t.includes(k));
                if (isRoutine || !c.client || c.client === "Unknown") return;

                if (!custMap[c.client]) custMap[c.client] = { name: c.client, count: 0, models: {}, faults: {}, parts: {} };
                custMap[c.client].count++;
                
                if (c.model) custMap[c.client].models[c.model] = (custMap[c.client].models[c.model] || 0) + 1;
                if (c.fault) {
                    const fShort = c.fault.substring(0, 15);
                    custMap[c.client].faults[fShort] = (custMap[c.client].faults[fShort] || 0) + 1;
                }
                c.parts.forEach(p => {
                    if (p.name && !['FALSE', 'TRUE'].includes(p.name.toUpperCase())) {
                        const cleanName = p.name.split(',')[0].trim();
                        custMap[c.client].parts[cleanName] = (custMap[c.client].parts[cleanName] || 0) + 1;
                    }
                });
            });

            const sortedCust = Object.values(custMap).sort((a,b) => b.count - a.count).slice(0, 5);
            const container = document.getElementById('topCustomersList');
            if(!container) return;
            container.innerHTML = "";

            if (sortedCust.length === 0) {
                container.innerHTML = `<div style="text-align:center; color:#999; grid-column: 1/-1; padding:20px;">ç„¡ç¶­ä¿®å«ä¿®æ•¸æ“š</div>`;
                return;
            }

            sortedCust.forEach((cust, index) => {
                const topModelEntry = Object.entries(cust.models).sort((a,b) => b[1] - a[1])[0];
                const topModelStr = topModelEntry ? `${topModelEntry[0]} (${topModelEntry[1]}å°)` : "ç„¡ç‰¹å®š";

                const topFaultEntry = Object.entries(cust.faults).sort((a,b) => b[1] - a[1])[0];
                const topFaultStr = topFaultEntry ? topFaultEntry[0] : "æœªè©³è¿°";

                const topParts = Object.entries(cust.parts).sort((a,b) => b[1] - a[1]).slice(0, 3);
                let partsHtml = "";
                if (topParts.length > 0) {
                    partsHtml = `<div class="cust-parts"><div class="cust-parts-title">ğŸ“¦ å¸¸ç”¨é›¶ä»¶ Top 3</div>` + 
                                topParts.map(p => `<div>- ${p[0]} (${p[1]})</div>`).join('') + `</div>`;
                } else {
                    partsHtml = `<div class="cust-parts" style="text-align:center;color:#ccc;">ç„¡é›¶ä»¶æ›´æ›ç´€éŒ„</div>`;
                }

                let suggestion = "æŒçºŒè§€å¯Ÿã€‚";
                if (topFaultStr.includes("æ‘”") || topFaultStr.includes("ç ´")) suggestion = "å»ºè­°å®‰æ’æ“ä½œè¡›æ•™ï¼Œæ¸›å°‘äººç‚ºæå£ã€‚";
                else if (topFaultStr.includes("ç•°éŸ³") || topFaultStr.includes("åµ")) suggestion = "å¯èƒ½æ˜¯é¢¨æ‰‡æˆ–æ¿¾ç¶²å•é¡Œï¼Œå»ºè­°æª¢æŸ¥ç’°å¢ƒè½å¡µã€‚";
                else if (topFaultStr.includes("ç„¡æ³•é–‹æ©Ÿ")) suggestion = "å»ºè­°æª¢æŸ¥é›»æºç·šæˆ–æ’åº§ç’°å¢ƒã€‚";
                else if (topModelStr.includes("Trilogy")) suggestion = "é«˜éšæ©Ÿç¨®ï¼Œè«‹ç¢ºèªæ˜¯å¦ç‚ºå®šæœŸæ›´æ›è€—æéœ€æ±‚ã€‚";

                const cardHtml = `
                    <div class="customer-card">
                        <div class="cust-rank">Rank ${index + 1}</div>
                        <div class="cust-name" title="${cust.name}">${cust.name}</div>
                        <div class="cust-stat"><span style="color:#64748b;">å«ä¿®ç¸½é‡</span><span style="color:#0ea5e9; font-size:1.1rem;">${cust.count} ä»¶</span></div>
                        <div class="cust-stat"><span style="color:#64748b;">ä¸»åŠ›æ©Ÿå‹</span><span style="font-size:0.85rem;">${topModelStr}</span></div>
                        <div class="cust-stat"><span style="color:#64748b;">å¸¸è¦‹æ•…éšœ</span><span style="font-size:0.85rem;" title="${topFaultStr}">${topFaultStr}</span></div>
                        ${partsHtml}
                        <div class="cust-suggestion"><strong>ğŸ’¡ å»ºè­°ï¼š</strong>${suggestion}</div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
        }

        function recalc() {
            if (uniqueCases.length === 0) return;
            const startVal = document.getElementById('startDate').value;
            const endVal = document.getElementById('endDate').value;
            const start = startVal ? new Date(startVal) : new Date(); start.setHours(0,0,0,0);
            const end = endVal ? new Date(endVal) : new Date(); end.setHours(23,59,59,999);
            
            const pts = {
                gen: parseFloat(document.getElementById('pt_gen').value) || 2, hard: parseFloat(document.getElementById('pt_hard').value) || 4,
                home: parseFloat(document.getElementById('pt_home').value) || 2, hosp_maint: parseFloat(document.getElementById('pt_hosp_maint').value) || 1,
                chk: parseFloat(document.getElementById('pt_chk').value) || 0.5, ext: parseFloat(document.getElementById('pt_ext').value) || 1,
                ref: parseFloat(document.getElementById('pt_ref').value) || 1.5, ins: parseFloat(document.getElementById('pt_ins').value) || 2.5,
                hosp_ins: parseFloat(document.getElementById('pt_hosp_ins').value) || 2, ctr: parseFloat(document.getElementById('pt_ctr').value) || 8,
                def: parseFloat(document.getElementById('pt_def').value) || 1
            };

            globalFilteredCases = [];
            uniqueCases.forEach(c => {
                if (!c.date || c.date < start || c.date > end) return;
                let p = pts.def; const t = c.type || "";
                if(t.includes("å›°é›£")) p = pts.hard; else if(t.includes("ç¡çœ ä¸­å¿ƒ")) p = pts.ctr;
                else if(t.includes("é†«é™¢è¨­å‚™å®‰è£")||t.includes("é†«é™¢è£æ©Ÿ")) p = pts.hosp_ins; else if(t.includes("è¨­å‚™è£æ©Ÿ")||t.includes("å±…å®¶è£æ©Ÿ")) p = pts.ins;
                else if(t.includes("é†«é™¢ä¿é¤Š")) p = pts.hosp_maint; else if(t.includes("å±…å®¶ä¿é¤Š")) p = pts.home;
                else if(t.includes("ä¸€èˆ¬")||t.includes("å…§ä¿®")) p = pts.gen; else if(t.includes("æ•´æ–°")) p = pts.ref;
                else if(t.includes("å¤–ä¿®")) p = pts.ext; else if(t.includes("æª¢æ¸¬")||t.includes("ç°¡æ˜“")) p = pts.chk;
                c.points = p; 
                globalFilteredCases.push(c);
            });

            clearDrillDown(false);
        }

        function clearDrillDown(render = true) {
            currentDrillDownLabel = null;
            safeSetStyle('filterNotice', 'display', 'none');
            if (render) updateDashboardViews(globalFilteredCases);
        }

        function populateSubFilters(cases) {
            const modelSet = new Set();
            const typeSet = new Set();
            cases.forEach(c => {
                const t = mapType(c.type);
                const m = (c.model && c.model !== '-' && c.model !== '') ? c.model : "æœªå¡«å¯«/å…¶ä»–";
                typeSet.add(t);
                modelSet.add(m);
            });
            
            const modelSelect = document.getElementById('subFilterModel');
            if(modelSelect) {
                const currentModel = modelSelect.value;
                modelSelect.innerHTML = '<option value="ALL">å…¨éƒ¨æ©Ÿå‹</option>' + Array.from(modelSet).sort().map(m => `<option value="${m}">${m}</option>`).join('');
                if (Array.from(modelSelect.options).some(o => o.value === currentModel)) modelSelect.value = currentModel;
            }
            
            const container = document.getElementById('subFilterTypeContainer');
            if(container) {
                const currentChecked = Array.from(document.querySelectorAll('.type-checkbox:checked')).map(cb => cb.value);
                const selectAllEl = document.getElementById('typeSelectAll');
                const isAllChecked = selectAllEl ? selectAllEl.checked : true;

                container.innerHTML = Array.from(typeSet).sort().map(t => {
                    const checked = isAllChecked || currentChecked.includes(t) ? 'checked' : '';
                    return `<label><input type="checkbox" class="type-checkbox" value="${t}" ${checked} onchange="handleTypeChange()"> ${t}</label>`;
                }).join('');
                updateTypeSelectText();
            }
        }

        function updateDashboardViews(casesToRender) {
            currentDisplayCases = casesToRender; 
            populateSubFilters(casesToRender); 

            let stats = {};
            let total = { cases: 0, points: 0, tatSum: 0, recallNum: 0, recallDenom: 0 };
            let strat = { 
                revenue: 0, extCost: 0, partsCost: 0, warrantyCount: 0, tatOutliers: 0, 
                totalPending: 0, totalBacklog: 0, totalConst: 0,
                models: {}, parts: {}, partsCostMap: {}, serviceDist: {} 
            };

            casesToRender.forEach(c => {
                const t = c.type || "";
                if (!stats[c.engineer]) stats[c.engineer] = { cases: 0, points: 0, tatSum: 0, recallNum: 0, recallDenom: 0, id: c.engineer };
                stats[c.engineer].cases++; stats[c.engineer].points += c.points; stats[c.engineer].tatSum += c.tat;
                total.cases++; total.points += c.points; total.tatSum += c.tat;

                if (isRepairType(c.type)) {
                    stats[c.engineer].recallDenom++; total.recallDenom++;
                    if (c.isRecall) { stats[c.engineer].recallNum++; total.recallNum++; }
                }

                strat.revenue += c.revenue || 0;
                strat.extCost += c.extCost || 0;
                if (c.warranty) strat.warrantyCount++;
                if (c.tat > 5) strat.tatOutliers++; 
                
                strat.totalPending += (c.pendingDays || 0);
                strat.totalBacklog += (c.backlogDays || 0);
                strat.totalConst += (c.constDays || 0);

                if (c.model && c.model !== '-' && c.model !== '') {
                    if (!["ä¿é¤Š", "æ•´æ–°", "è£æ©Ÿ", "å®‰è£", "å…¶ä»–"].some(keyword => t.includes(keyword))) {
                        strat.models[c.model] = (strat.models[c.model] || 0) + 1;
                    }
                }

                let casePartsCost = 0;
                c.parts.forEach(part => {
                    if (part.name && !['FALSE', 'TRUE'].includes(part.name.toUpperCase())) {
                        const key = `${part.no || ''}||${part.name}`; 
                        strat.parts[key] = (strat.parts[key] || 0) + 1;
                        
                        const pNo = (part.no || "").trim().toUpperCase();
                        if (pNo && partCosts[pNo]) {
                            casePartsCost += partCosts[pNo];
                            strat.partsCostMap[key] = (strat.partsCostMap[key] || 0) + partCosts[pNo];
                        }
                    }
                });
                strat.partsCost += casePartsCost;
            });

            // Safeguard UI updates
            safeSetText('totalUnique', total.cases);
            safeSetText('totalPoints', total.points.toFixed(1));
            
            const avgTatStr = total.cases ? (total.tatSum/total.cases).toFixed(1) : 0;
            const avgBacklogStr = total.cases ? (strat.totalBacklog/total.cases).toFixed(1) : 0;
            const avgConstStr = total.cases ? (strat.totalConst/total.cases).toFixed(1) : 0;
            
            safeSetText('avgTat', avgTatStr + " å¤©");
            safeSetText('pendingSaved', `å·²æ‰£é™¤ç­‰å¾…æœŸ: ${strat.totalPending}å¤©`);
            safeSetText('avgBacklog', avgBacklogStr + " å¤©");
            safeSetText('avgConstDays', avgConstStr + " å¤©");

            const rwoPercent = total.recallDenom ? ((total.recallNum/total.recallDenom)*100) : 0;
            safeSetText('rwoRate', rwoPercent.toFixed(1) + "%");
            safeSetText('ftfRate', (100 - rwoPercent).toFixed(1) + "%");
            
            const grossMargin = strat.revenue - strat.extCost - strat.partsCost;
            safeSetText('grossMargin', grossMargin.toLocaleString());
            safeSetText('financialDetail', `æ”¶è²»: $${strat.revenue.toLocaleString()} | å¤–ä¿®: $${strat.extCost.toLocaleString()} | é›¶ä»¶: $${strat.partsCost.toLocaleString()}`);
            
            const slaRate = total.cases ? ((strat.tatOutliers / total.cases) * 100).toFixed(1) : 0;
            safeSetText('slaOutlierRate', slaRate + "%");
            safeSetStyle('slaOutlierRate', 'color', slaRate > 10 ? '#dc2626' : '#1e293b'); 
            safeSetText('slaDetail', `è¶…æ¨™ä»¶æ•¸: ${strat.tatOutliers} ä»¶ (æŸ¥çœ‹æ˜ç´°)`);

            const warRate = total.cases ? ((strat.warrantyCount / total.cases) * 100).toFixed(1) : 0;
            safeSetText('warrantyRate', warRate + "%");
            safeSetText('warrantyDetail', `ä¿å›ºå…§: ${strat.warrantyCount} ä»¶`);

            const tbody = document.getElementById('tableBody'); 
            if(tbody) {
                tbody.innerHTML = "";
                const sortedEng = Object.values(stats).sort((a,b) => b.points - a.points);
                const targetPoints = parseFloat(document.getElementById('targetPoints').value) || 150;
                
                let engBubbleData = [];

                sortedEng.forEach(s => {
                    const avgTat = s.cases ? (s.tatSum / s.cases) : 0;
                    let scoreTat = 0, classTat = "score-mid";
                    if (avgTat <= 3.0) { scoreTat = 100; classTat = "score-good"; } else if (avgTat <= 4.0) { scoreTat = 90; classTat = "score-good"; }
                    else if (avgTat <= 5.0) { scoreTat = 80; classTat = "score-mid"; } else { scoreTat = 60; classTat = "score-bad"; }

                    const achv = (s.points / targetPoints) * 100;
                    let scorePoints = Math.min(achv, 100);
                    let classPoints = achv >= 100 ? "score-good" : (achv >= 80 ? "score-mid" : "score-bad");

                    const rr = s.recallDenom ? (s.recallNum / s.recallDenom) * 100 : 0;
                    let scoreRwo = 0, classRwo = "score-good";
                    if (s.recallDenom === 0) { scoreRwo = 100; } else {
                        if (rr === 0) { scoreRwo = 100; } else if (rr <= 2) { scoreRwo = 90; classRwo = "score-mid"; } else { scoreRwo = 60; classRwo = "score-bad"; }
                    }
                    const scoreCoop = 90; 
                    const finalScore = (scoreTat * 0.3) + (scorePoints * 0.3) + (scoreRwo * 0.2) + (scoreCoop * 0.2);

                    engBubbleData.push({
                        x: s.points, y: avgTat, r: Math.max(rr * 1.5, 6), engineer: s.id, cases: s.cases, rr: rr
                    });

                    tbody.innerHTML += `<tr>
                        <td style="font-weight:bold;"><span class="eng-link" onclick="openModal('${s.id}')">${s.id}</span></td>
                        <td style="text-align:center;">${s.cases}</td><td style="text-align:center;">${s.points.toFixed(1)}</td>
                        <td style="text-align:center;"><span class="${classPoints}">${achv.toFixed(0)}%</span></td>
                        <td style="text-align:center;" title="å·²æ‰£é™¤å‡æ—¥èˆ‡å¾…æ–™">${avgTat.toFixed(1)}</td><td style="text-align:center;"><span class="${classTat}">${scoreTat}</span></td>
                        <td style="text-align:center;">${rr.toFixed(1)}% (${s.recallNum})</td><td style="text-align:center;"><span class="${classRwo}">${scoreRwo}</span></td>
                        <td style="text-align:center;"><input type="number" value="${scoreCoop}" style="width:50px;text-align:center;" oninput="updateRowScore(this,${scoreTat},${scorePoints},${scoreRwo})"></td>
                        <td style="text-align:center; font-weight:bold; font-size:1.1rem;">${finalScore.toFixed(0)}</td>
                    </tr>`;
                });

                const sortedModels = Object.entries(strat.models).sort((a,b) => b[1] - a[1]).slice(0, 5);
                const sortedParts = Object.entries(strat.parts).sort((a,b) => b[1] - a[1]).slice(0, 10);
                const sortedPartsByCost = Object.entries(strat.partsCostMap).sort((a,b) => b[1] - a[1]).slice(0, 10);
                
                reportData = {
                    totalCases: total.cases, totalPoints: total.points, recallRate: total.recallDenom ? (total.recallNum/total.recallDenom)*100 : 0,
                    revenue: strat.revenue, extCost: strat.extCost, partsCost: strat.partsCost, gross: grossMargin,
                    tatOutliers: strat.tatOutliers, slaRate: slaRate, 
                    avgTat: avgTatStr, avgBacklog: avgBacklogStr, avgConstDays: avgConstStr, 
                    warrantyCount: strat.warrantyCount, warRate: warRate,
                    serviceDistribution: strat.serviceDist, topModels: sortedModels,
                    topEngineer: sortedEng.length > 0 ? { name: sortedEng[0].id, points: sortedEng[0].points } : { name: "ç„¡", points: 0 },
                    sortedPartsRaw: sortedParts, sortedPartsByCost: sortedPartsByCost, engBubbleData: engBubbleData
                };
            }

            renderPartsTable();
            if (!currentDrillDownLabel) renderServiceChart(globalFilteredCases);
            renderSubCharts(); 
            generateAnalysisReport();
            generateTopCustomersReport(casesToRender);
        }

        function renderPartsTable() {
            const partsBody = document.getElementById('partsBody');
            if(!partsBody) return;
            partsBody.innerHTML = "";
            const maxPartCount = reportData.sortedPartsRaw.length > 0 ? reportData.sortedPartsRaw[0][1] : 1;

            reportData.sortedPartsRaw.forEach((item, index) => {
                const [key, count] = item;
                const [pNo, pName] = key.split('||'); 
                const cost = partCosts[pNo] ? (partCosts[pNo] * count).toLocaleString() : '0';

                partsBody.innerHTML += `
                    <tr>
                        <td style="text-align:center; color:#999;">${index + 1}</td>
                        <td style="font-family:monospace; color:#475569;">${pNo || '-'}</td>
                        <td style="font-weight:500;">${pName}</td>
                        <td style="text-align:right; font-weight:bold; color:var(--primary);">${count}</td>
                        <td style="text-align:right; color:#be123c;">$${cost}</td>
                        <td>
                            <div style="background:#f1f5f9; height:10px; border-radius:5px; width:100%;">
                                <div style="background:var(--primary); height:10px; border-radius:5px; width:${(count/maxPartCount)*100}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        function updateChartGranularity(g, btn) {
            currentGranularity = g; 
            document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active')); 
            btn.classList.add('active'); 
            clearDrillDown(); 
        }

        function renderServiceChart(cases) {
            if (!cases.length) return;
            const groupedData = {}; const serviceTypes = new Set();
            cases.forEach(c => {
                if(!c.date) return; let l = ""; const y = c.date.getFullYear(), m = c.date.getMonth() + 1;
                if (currentGranularity === 'year') l = `${y}å¹´`; else if (currentGranularity === 'quarter') l = `${y}-Q${Math.ceil(m/3)}`; else l = `${y}-${String(m).padStart(2,'0')}`;
                if (!groupedData[l]) groupedData[l] = {}; const t = mapType(c.type); serviceTypes.add(t);
                groupedData[l][t] = (groupedData[l][t] || 0) + 1;
            });
            const labels = Object.keys(groupedData).sort(); const typesArray = Array.from(serviceTypes);
            const colors = { "ä¸€èˆ¬ç¶­ä¿®": "#3b82f6", "å›°é›£ç¶­ä¿®": "#ef4444", "å±…å®¶ä¿é¤Š": "#22c55e", "é†«é™¢ä¿é¤Š": "#15803d", "å±…å®¶è£æ©Ÿ": "#f59e0b", "é†«é™¢å®‰è£": "#c2410c", "ç°¡æ˜“æª¢æ¸¬": "#a855f7", "å¤–ä¿®åˆ¤å®š": "#64748b", "æ‰¹é‡æ•´æ–°": "#06b6d4", "ç¡çœ ä¸­å¿ƒ": "#6366f1", "å…¶ä»–é è¨­": "#94a3b8" };
            
            const ctx = document.getElementById('serviceChart');
            if(!ctx) return;
            if (serviceChartInstance) serviceChartInstance.destroy();
            serviceChartInstance = new Chart(ctx.getContext('2d'), {
                type: 'bar', 
                data: { labels: labels, datasets: typesArray.map(t => ({ label: t, data: labels.map(l => groupedData[l][t] || 0), backgroundColor: colors[t]||"#cbd5e1" })) },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    interaction: { mode: 'index', intersect: false },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const label = serviceChartInstance.data.labels[index];
                            applyDrillDown(label);
                        }
                    },
                    plugins: { 
                        legend: { position: 'bottom', labels:{boxWidth:10} },
                        tooltip: { usePointStyle: true, callbacks: { footer: (items) => { let total=0; items.forEach(i => {total+=i.parsed.y;}); return '\nç¸½è¨ˆ: ' + total + ' ä»¶'; } } }
                    }, 
                    scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, beginAtZero: true } } 
                }
            });
        }

        function applyDrillDown(label) {
            currentDrillDownLabel = label;
            safeSetStyle('filterNotice', 'display', 'block');
            safeSetText('filterNotice', `ğŸ”„ ç¯©é¸ä¸­: ${label} (é»æ­¤æ¸…é™¤)`);
            
            const subCases = globalFilteredCases.filter(c => {
                if(!c.date) return false;
                const y = c.date.getFullYear(), m = c.date.getMonth() + 1;
                let cLabel = "";
                if (currentGranularity === 'year') cLabel = `${y}å¹´`;
                else if (currentGranularity === 'quarter') cLabel = `${y}-Q${Math.ceil(m/3)}`;
                else cLabel = `${y}-${String(m).padStart(2,'0')}`;
                return cLabel === label;
            });

            updateDashboardViews(subCases);
        }

        function renderDoughnut(instance, canvasId, dataObj, clickable = false) {
            if (instance) instance.destroy();
            const ctx = document.getElementById(canvasId);
            if(!ctx) return null;
            return new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: { labels: dataObj.labels, datasets: [{ data: dataObj.data, backgroundColor: dataObj.bg, borderWidth: 1 }] },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '50%',
                    onClick: (e, elements) => {
                        if (clickable && elements.length > 0) {
                            const index = elements[0].index;
                            const label = dataObj.labels[index];
                            if(label !== "ç„¡è³‡æ–™") openDeepAnalysisModal(canvasId, label);
                        }
                    },
                    plugins: {
                        legend: { position: 'right', labels: {boxWidth: 10, font: {size: 11}} },
                        tooltip: { callbacks: { label: function(ctx) { if (dataObj.labels[0] === 'ç„¡è³‡æ–™') return ' ç„¡è³‡æ–™'; return ' ' + ctx.label + ': ' + ctx.parsed + 'ä»¶'; } } }
                    }
                }
            });
        }

        function renderDeepAnalysisCharts() {
            const selModel = document.getElementById('subFilterModel') ? document.getElementById('subFilterModel').value : 'ALL';
            const checkboxes = document.querySelectorAll('.type-checkbox');
            const checkedTypes = Array.from(document.querySelectorAll('.type-checkbox:checked')).map(cb => cb.value);
            const isAllTypes = checkedTypes.length === checkboxes.length || checkedTypes.length === 0;

            const subCases = currentDisplayCases.filter(c => {
                const t = mapType(c.type);
                const m = (c.model && c.model !== '-' && c.model !== '') ? c.model : "æœªå¡«å¯«/å…¶ä»–";
                if (selModel !== 'ALL' && m !== selModel) return false;
                if (!isAllTypes && !checkedTypes.includes(t)) return false;
                return true;
            });

            let slaTypes = {}, slaModels = {}, warTypes = {}, warModels = {};
            subCases.forEach(c => {
                const t = mapType(c.type);
                const m = (c.model && c.model !== '-' && c.model !== '') ? c.model : "æœªå¡«å¯«/å…¶ä»–";
                if (c.tat > 5) { slaTypes[t] = (slaTypes[t] || 0) + 1; slaModels[m] = (slaModels[m] || 0) + 1; }
                if (c.warranty) { warTypes[t] = (warTypes[t] || 0) + 1; warModels[m] = (warModels[m] || 0) + 1; }
            });

            const formatChartData = (dataObj, maxItems = 0, colorPalette) => {
                let entries = Object.entries(dataObj).sort((a, b) => b[1] - a[1]);
                if (maxItems > 0) entries = entries.slice(0, maxItems);
                if (entries.length === 0) return { labels: ["ç„¡è³‡æ–™"], data: [1], bg: ["#e2e8f0"] };
                return { labels: entries.map(e => e[0]), data: entries.map(e => e[1]), bg: entries.map((_, i) => colorPalette[i % colorPalette.length]) };
            };

            const slaColors = ['#e11d48', '#f43f5e', '#fb923c', '#f59e0b', '#fbbf24', '#a3e635'];
            const warColors = ['#0284c7', '#0ea5e9', '#38bdf8', '#818cf8', '#a855f7', '#d946ef'];

            slaTypeChartInst = renderDoughnut(slaTypeChartInst, 'slaTypeChart', formatChartData(slaTypes, 0, slaColors), true);
            slaModelChartInst = renderDoughnut(slaModelChartInst, 'slaModelChart', formatChartData(slaModels, 5, slaColors), true);
            warTypeChartInst = renderDoughnut(warTypeChartInst, 'warTypeChart', formatChartData(warTypes, 0, warColors), true);
            warModelChartInst = renderDoughnut(warModelChartInst, 'warModelChart', formatChartData(warModels, 5, warColors), true);
        }

        function renderSubCharts() {
            if (partsChartInstance) partsChartInstance.destroy();
            const pCtx = document.getElementById('partsChart');
            if(pCtx) {
                partsChartInstance = new Chart(pCtx.getContext('2d'), {
                    type: 'bar', indexAxis: 'y',
                    data: { labels: reportData.sortedPartsRaw.map(i => i[0].split('||')[1].split(',')[0].trim().substring(0,15)), datasets: [{ label: 'æ¶ˆè€—æ•¸é‡', data: reportData.sortedPartsRaw.map(i => i[1]), backgroundColor: '#0ea5e9', borderRadius: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true }, y: { grid: { display: false } } } }
                });
            }

            if (partsCostChartInstance) partsCostChartInstance.destroy();
            const pcCtx = document.getElementById('partsCostChart');
            if(pcCtx) {
                partsCostChartInstance = new Chart(pcCtx.getContext('2d'), {
                    type: 'bar', indexAxis: 'y',
                    data: { labels: reportData.sortedPartsByCost.map(i => i[0].split('||')[1].split(',')[0].trim().substring(0,15)), datasets: [{ label: 'ç¸½æˆæœ¬ (NT$)', data: reportData.sortedPartsByCost.map(i => i[1]), backgroundColor: '#be123c', borderRadius: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true }, y: { grid: { display: false } } } }
                });
            }

            if (engBubbleChartInst) engBubbleChartInst.destroy();
            const ebCtx = document.getElementById('engBubbleChart');
            if(ebCtx) {
                engBubbleChartInst = new Chart(ebCtx.getContext('2d'), {
                    type: 'bubble',
                    data: { datasets: [{ label: 'å·¥ç¨‹å¸«æ•ˆèƒ½', data: reportData.engBubbleData, backgroundColor: 'rgba(2, 132, 199, 0.6)', borderColor: '#0284c7', borderWidth: 1 }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(ctx) { const d = ctx.raw; return `${d.engineer}: ç”¢èƒ½ ${d.x.toFixed(1)}é», TAT ${d.y.toFixed(1)}å¤©, è¿”ä¿®ç‡ ${d.rr.toFixed(1)}%`; } } } },
                        scales: { x: { title: { display: true, text: 'ç”¢èƒ½é»æ•¸ (è¶Šé«˜è¶Šå¥½)' }, beginAtZero: true }, y: { title: { display: true, text: 'å¹³å‡æ·¨ TAT (è¶Šä½è¶Šå¥½)' }, beginAtZero: true, reverse: true } }
                    }
                });
            }

            if (tatChartInstance) tatChartInstance.destroy();
            let tatBins = {"1-3å¤© (å„ªè‰¯)": 0, "4-5å¤© (é”æ¨™)": 0, "è¶…é5å¤© (è¶…æ¨™)": 0};
            currentDisplayCases.forEach(c => {
                if (c.tat <= 3) tatBins["1-3å¤© (å„ªè‰¯)"]++; else if (c.tat <= 5) tatBins["4-5å¤© (é”æ¨™)"]++; else tatBins["è¶…é5å¤© (è¶…æ¨™)"]++;
            });
            const tCtx = document.getElementById('tatChart');
            if(tCtx) {
                tatChartInstance = new Chart(tCtx.getContext('2d'), {
                    type: 'doughnut', data: { labels: Object.keys(tatBins), datasets: [{ data: Object.values(tatBins), backgroundColor: ['#10b981', '#f59e0b', '#ef4444'], borderWidth: 1 }] },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom' } } }
                });
            }

            if (warrantyChartInstance) warrantyChartInstance.destroy();
            let warBins = {"ä¿å›º/åˆç´„å…§": 0, "ä¸€èˆ¬è‡ªè²»": 0};
            currentDisplayCases.forEach(c => { if (c.warranty) warBins["ä¿å›º/åˆç´„å…§"]++; else warBins["ä¸€èˆ¬è‡ªè²»"]++; });
            const wCtx = document.getElementById('warrantyChart');
            if(wCtx) {
                warrantyChartInstance = new Chart(wCtx.getContext('2d'), {
                    type: 'doughnut', data: { labels: Object.keys(warBins), datasets: [{ data: Object.values(warBins), backgroundColor: ['#3b82f6', '#94a3b8'], borderWidth: 1 }] },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom' } } }
                });
            }

            if (modelChartInstance) modelChartInstance.destroy();
            const mCtx = document.getElementById('modelChart');
            if(mCtx) {
                modelChartInstance = new Chart(mCtx.getContext('2d'), {
                    type: 'doughnut', data: { labels: reportData.topModels.map(m => m[0]), datasets: [{ data: reportData.topModels.map(m => m[1]), backgroundColor: ['#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16'], borderWidth: 1 }] },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom' } } }
                });
            }

            renderDeepAnalysisCharts();
        }

        function generateAnalysisReport() {
            let marginText = reportData.gross > 0 
                ? `æœ¬æœŸç¶­ä¿®ä½œæ¥­ç”¢ç”Ÿ <span class="highlight-green">æ­£å‘æ¯›åˆ© $${reportData.gross.toLocaleString()}</span>ï¼Œæœ‰åŠ©æ–¼éƒ¨é–€åˆ©æ½¤åŒ–ç›®æ¨™ã€‚`
                : (reportData.gross < 0 ? `<span class="highlight-red">è­¦ç¤ºï¼šæœ¬æœŸæ¯›åˆ©ç‚ºè²  ($${reportData.gross.toLocaleString()})</span>ï¼Œè«‹æª¢è¦–å¤–ä¿®èˆ‡é›¶ä»¶æˆæœ¬ã€‚` : `æœ¬æœŸæ”¶è²»èˆ‡å¤–/å…§ä¿®æˆæœ¬æŠµéŠ·ï¼Œæ¯›åˆ©æŒå¹³ã€‚`);

            let modelHtml = reportData.topModels.length > 0 
                ? `å¦¥å–„ç‡é—œæ³¨ï¼šé€²å ´æœ€é«˜æ©Ÿå‹ç‚º <span class="highlight-blue">${reportData.topModels[0][0]}</span> (${reportData.topModels[0][1]}ä»¶)ï¼Œè«‹ç•™æ„å¸‚å ´å®¢è¨´ã€‚` : "ç„¡ç¶­ä¿®æ©Ÿå‹æ•¸æ“šã€‚";

            safeSetHtml('textStrategic', `<ul><li>${marginText}</li><li>ä¿å›ºå…§æ¡ˆä»¶ä½”ç¸½é‡ <strong>${reportData.warRate}%</strong>ã€‚è‹¥æ­¤æ¯”ä¾‹æŒçºŒæ”€å‡ï¼Œéœ€å‘åŸå» çˆ­å– RWO è£œè²¼ã€‚</li><li>${modelHtml}</li></ul>`);

            let actionsHtml = "<ul>"; let hasAction = false;
            if (reportData.slaRate > 5) { actionsHtml += `<li><span class="highlight-red">â³ SLA é•·å°¾è­¦ç¤º</span>ï¼šæœ‰ ${reportData.tatOutliers} ä»¶æ·¨è™•ç†è¶…é 5 å·¥ä½œæ—¥ã€‚å»ºè­°é»æ“Šæ˜ç´°å¾¹æŸ¥ã€‚</li>`; hasAction = true; }
            if (parseFloat(reportData.avgBacklog) > 2.0) { actionsHtml += `<li><span class="highlight-red">âš ï¸ å¾…ä¿®ç©å£“é è­¦</span>ï¼šå¹³å‡å¾…ä¿®æ™‚é•·é” ${reportData.avgBacklog} å¤©ï¼Œä»£è¡¨å€‰åº«ç©å£“ã€‚</li>`; hasAction = true; }
            if (reportData.recallRate > 2.0) { actionsHtml += `<li><span class="highlight-red">âš ï¸ å“è³ªè­¦ç¤º</span>ï¼šè¿”ä¿®ç‡é” ${reportData.recallRate.toFixed(1)}% (ç›®æ¨™<2%)ã€‚</li>`; hasAction = true; }
            if (!hasAction) actionsHtml += `<li><span class="highlight-green">âœ… ç‡Ÿé‹ç©©å®š</span>ï¼šæ•ˆç‡ã€RWOã€åˆ©æ½¤å‡åœ¨æ§åˆ¶ç¯„åœå…§ã€‚</li>`;
            safeSetHtml('textAction', actionsHtml + "</ul>");

            safeSetHtml('textSummary', `
                <ul>
                    <li><strong>ç”¢èƒ½èˆ‡åˆ©æ½¤ï¼š</strong> æœ¬æœŸå®Œä¿® ${reportData.totalCases} ä»¶ï¼Œå‰µé€  ${reportData.totalPoints.toFixed(0)} é»ç”¢èƒ½ã€‚æ‰£é™¤é›¶ä»¶å¤–ä¿®å¾Œæ¯›åˆ©ç‚º $${reportData.gross.toLocaleString()}ã€‚</li>
                    <li><strong>æµé€Ÿèˆ‡æ•ˆç‡ï¼š</strong> æ·¨TATæ§åˆ¶åœ¨ ${reportData.avgTat} å·¥ä½œæ—¥ï¼Œå…¶ä¸­å¾…ä¿®æ™‚é•·å¹³å‡ ${reportData.avgBacklog} å¤©ï¼Œæ–½å·¥å¤©æ•¸ ${reportData.avgConstDays} å¤©ã€‚</li>
                    <li><strong>æœå‹™å“è³ªï¼š</strong> é¦–æ¬¡ä¿®å¾©ç‡ (FTF) ${(100-reportData.recallRate).toFixed(1)}%ï¼ŒSLAé•·å°¾ç‡(>5æ—¥)ä½” ${reportData.slaRate}%ã€‚</li>
                    <li><strong>æœ€ä½³è¡¨ç¾ï¼š</strong> MVP ç‚º ${reportData.topEngineer.name} (${reportData.topEngineer.points.toFixed(0)} é»)ã€‚</li>
                </ul><div style="font-size:0.85rem; color:#94a3b8; margin-top:5px;">(å¯ç›´æ¥è¤‡è£½ç”¨æ–¼æœˆæœƒå ±å‘Š)</div>`);
        }

        function openModal(eng) {
            safeSetStyle('modalAnalysisText', 'display', 'none');
            safeSetText('modalTitle', `å·¥ç¨‹å¸«ï¼š${eng} - æ¡ˆä»¶æ˜ç´°`);
            const tbody = document.getElementById('modalBody'); if(!tbody) return; tbody.innerHTML = "";
            const cases = currentDisplayCases.filter(c => c.engineer === eng).sort((a,b) => (b.date||0) - (a.date||0));
            renderModalRows(cases, tbody);
            safeSetStyle('detailModal', 'display', 'block');
        }

        function openSlaModal() {
            safeSetStyle('modalAnalysisText', 'display', 'none');
            safeSetText('modalTitle', `ğŸš¨ SLA é•·å°¾é€¾æœŸæ¡ˆä»¶æ˜ç´° (æ·¨TAT > 5å·¥ä½œå¤©)`);
            const tbody = document.getElementById('modalBody'); if(!tbody) return; tbody.innerHTML = "";
            const cases = currentDisplayCases.filter(c => c.tat > 5).sort((a,b) => b.tat - a.tat);
            renderModalRows(cases, tbody, true);
            safeSetStyle('detailModal', 'display', 'block');
        }

        function openDeepAnalysisModal(chartId, label) {
            const selModel = document.getElementById('subFilterModel') ? document.getElementById('subFilterModel').value : 'ALL';
            const checkboxes = document.querySelectorAll('.type-checkbox');
            const checkedTypes = Array.from(document.querySelectorAll('.type-checkbox:checked')).map(cb => cb.value);
            const isAllTypes = checkedTypes.length === checkboxes.length || checkedTypes.length === 0;
            
            const subCases = currentDisplayCases.filter(c => {
                const t = mapType(c.type);
                const m = (c.model && c.model !== '-' && c.model !== '') ? c.model : "æœªå¡«å¯«/å…¶ä»–";
                if (selModel !== 'ALL' && m !== selModel) return false;
                if (!isAllTypes && !checkedTypes.includes(t)) return false;
                return true;
            });

            let filtered = []; let title = ""; let totalContext = 0; let isSla = false;

            if (chartId === 'slaTypeChart') {
                const baseSla = subCases.filter(c => c.tat > 5); totalContext = baseSla.length;
                filtered = baseSla.filter(c => mapType(c.type) === label); title = `ğŸš¨ SLA é€¾æœŸæ¡ˆä»¶åˆ†æ - åˆ†é¡: ${label}`; isSla = true;
            } else if (chartId === 'slaModelChart') {
                const baseSla = subCases.filter(c => c.tat > 5); totalContext = baseSla.length;
                filtered = baseSla.filter(c => { const m = (c.model && c.model !== '-' && c.model !== '') ? c.model : "æœªå¡«å¯«/å…¶ä»–"; return m === label; });
                title = `ğŸš¨ SLA é€¾æœŸæ¡ˆä»¶åˆ†æ - æ©Ÿå‹: ${label}`; isSla = true;
            } else if (chartId === 'warTypeChart') {
                const baseWar = subCases.filter(c => c.warranty); totalContext = baseWar.length;
                filtered = baseWar.filter(c => mapType(c.type) === label); title = `ğŸ›¡ï¸ ä¿å›ºå…§æ¡ˆä»¶åˆ†æ - åˆ†é¡: ${label}`;
            } else if (chartId === 'warModelChart') {
                const baseWar = subCases.filter(c => c.warranty); totalContext = baseWar.length;
                filtered = baseWar.filter(c => { const m = (c.model && c.model !== '-' && c.model !== '') ? c.model : "æœªå¡«å¯«/å…¶ä»–"; return m === label; });
                title = `ğŸ›¡ï¸ ä¿å›ºå…§æ¡ˆä»¶åˆ†æ - æ©Ÿå‹: ${label}`;
            }

            const pct = totalContext > 0 ? ((filtered.length / totalContext) * 100).toFixed(1) : 0;
            let avgTat = (filtered.reduce((sum, c) => sum + c.tat, 0) / (filtered.length || 1)).toFixed(1);
            
            let partsMap = {}; let modelCount = {}, statusCount = { 'æ­£å¸¸å®Œä¿®': 0, 'è¿”ä¿®å–®': 0, 'SLAé€¾æœŸ': 0 }, typeCount = {}, reqCount = {}, contractCount = 0;

            filtered.forEach(c => {
                c.parts.forEach(p => { if (p.name && !['FALSE', 'TRUE'].includes(p.name.toUpperCase())) { const cleanName = p.name.split(',')[0].trim(); partsMap[cleanName] = (partsMap[cleanName] || 0) + 1; } });
                let m = (c.model && c.model !== '-' && c.model !== '') ? c.model : 'æœªå¡«å¯«'; modelCount[m] = (modelCount[m] || 0) + 1;
                if (c.isRecall) statusCount['è¿”ä¿®å–®']++; else statusCount['æ­£å¸¸å®Œä¿®']++;
                if (c.tat > 5) statusCount['SLAé€¾æœŸ']++;
                let t = mapType(c.type); typeCount[t] = (typeCount[t] || 0) + 1;
                let r = c.req || 'æœªå¡«å¯«'; reqCount[r] = (reqCount[r] || 0) + 1;
                if (r.includes('ç¶­è­·åˆç´„') || r.includes('åˆç´„')) contractCount++;
            });

            const getTop3 = (obj) => { let sorted = Object.entries(obj).sort((a,b)=>b[1]-a[1]).filter(x=>x[0]!=='æœªå¡«å¯«'); if(sorted.length === 0) return 'ç„¡'; return sorted.slice(0,3).map(x=>`${x[0]}(${x[1]})`).join('ã€'); };
            const topParts = getTop3(partsMap); const topModels = getTop3(modelCount); const topTypes = getTop3(typeCount); const topReqs = getTop3(reqCount);

            let analysisHtml = `
                <strong style="font-size:1.05rem;">ğŸ“Š å€å¡Šæ•¸æ“šæ´å¯Ÿï¼š</strong><br>
                1. è©²æ¢ä»¶ä¸‹å…±æœ‰ <strong style="font-size:1.1rem; color:#0ea5e9;">${filtered.length}</strong> ä»¶ï¼Œä½”æ“šåˆ†ææ¯é«”çš„ <strong>${pct}%</strong>ã€‚<br>
                2. æ­¤å€å¡Šæ¡ˆä»¶çš„å¹³å‡æ·¨è™•ç†æ™‚æ•ˆç‚º <strong style="color:${isSla ? '#dc2626' : '#1e293b'}">${avgTat}</strong> å·¥ä½œæ—¥ã€‚<br>
                3. ${topParts !== 'ç„¡' ? `æœ€å¸¸æ¶ˆè€—é›¶ä»¶ Top 3ï¼š<span style="color:#059669; font-weight:bold;">${topParts}</span>ã€‚` : 'ç„¡ç‰¹åˆ¥é›†ä¸­æ¶ˆè€—ä¹‹é›¶ä»¶ç´€éŒ„ã€‚'}<br>
                <hr style="border: 0; border-top: 1px dashed #10b981; margin: 10px 0; opacity: 0.3;">
                <strong style="font-size:0.95rem; color:#064e3b;">ğŸ“Œ ç´°éƒ¨çµ„æˆçµ±è¨ˆï¼š</strong>
                <ul style="margin: 4px 0; padding-left: 20px; font-size: 0.9rem; color:#065f46;">
                    <li><strong>æ©Ÿå‹åˆ†ä½ˆï¼š</strong> ${topModels}</li>
                    <li><strong>æ¡ˆä»¶ç‹€æ…‹ï¼š</strong> æ­£å¸¸å®Œä¿®(${statusCount['æ­£å¸¸å®Œä¿®']})ã€è¿”ä¿®å–®(${statusCount['è¿”ä¿®å–®']})ã€SLAé€¾æœŸ(${statusCount['SLAé€¾æœŸ']})</li>
                    <li><strong>ç¶­ä¿®é¡å‹ï¼š</strong> ${topTypes}</li>
                    <li><strong>éœ€æ±‚ä¾†æºï¼š</strong> ${topReqs} <span style="background:#d1fae5; color:#047857; padding:1px 6px; border-radius:4px; font-weight:bold; margin-left:5px;">å…¶ä¸­ã€Œç¶­è­·åˆç´„ã€å…± ${contractCount} ä»¶</span></li>
                </ul>
            `;
            safeSetText('modalTitle', title);
            safeSetHtml('modalAnalysisText', analysisHtml); 
            safeSetStyle('modalAnalysisText', 'display', 'block');
            
            const tbody = document.getElementById('modalBody'); if(!tbody) return; tbody.innerHTML = "";
            renderModalRows(filtered.sort((a,b)=>b.tat-a.tat), tbody, isSla);
            safeSetStyle('detailModal', 'display', 'block');
        }

        function renderModalRows(cases, tbody, isSlaView = false) {
            if (!cases.length) { tbody.innerHTML = "<tr><td colspan='10' style='text-align:center'>ç„¡ç›¸é—œè³‡æ–™</td></tr>"; } else {
                cases.forEach(c => {
                    let status = c.isRecall ? `<span class="tag-recall">è¿”ä¿®</span><br><span style="font-size:0.7rem;color:#991b1b;">é—œè¯: ${c.recallRef}</span>` : '<span style="color:#aaa">æ­£å¸¸</span>';
                    if(c.tat > 5) status += `<br><span style="background:#fef08a; color:#854d0e; padding:1px 4px; border-radius:3px; font-size:0.7rem; margin-top:2px; display:inline-block;">SLAé€¾æœŸ</span>`;
                    if(c.pendingDays > 0) status += `<br><span style="color:#0284c7; font-size:0.7rem;">(æ‰£é™¤å¾…æ–™${c.pendingDays}å¤©)</span>`;
                    let rowColor = (isSlaView && c.tat > 5) ? 'background-color:#fff7ed;' : '';
                    tbody.innerHTML += `<tr style="${rowColor}">
                        <td>${c.id}</td><td>${c.date?c.date.toISOString().split('T')[0]:'-'}</td><td>${c.model||'-'}</td><td>${c.sn||'-'}</td>
                        <td style="text-align:center; color:#94a3b8;">${c.rawTat}</td>
                        <td style="text-align:center; font-size:1.05rem; ${c.tat>5?'color:#dc2626;font-weight:bold;':''}">${c.tat}</td>
                        <td style="text-align:center;">${status}</td>
                        <td>${c.type}</td><td style="text-align:center; font-weight:bold; color:#0369a1;">${c.points?c.points.toFixed(1):'0'}</td>
                        <td style="font-size:0.8rem; color:#666;">${c.parts.map(p=>`${p.no?`[${p.no}]`:''}${p.name}`).join('<br>')}</td>
                    </tr>`;
                });
            }
        }

        function closeModal() { safeSetStyle('detailModal', 'display', 'none'); }
        window.onclick = function(e) { if(e.target == document.getElementById('detailModal')) closeModal(); }
    </script>
</body>
</html>